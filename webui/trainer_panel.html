<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Trainer Panel â€” JeebsAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="padding-top:60px">
  <h1 style="margin-bottom:4px">Trainer Panel</h1>
  <p class="text-muted" style="margin-bottom:24px">Training controls for trainers and admins.</p>

  <div id="authStatus" class="card" style="padding:12px;margin-bottom:16px"><span class="text-muted">Checking access...</span></div>

  <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(300px,1fr))">
    <div class="card">
      <h3>Quick Training Commands</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn btn-ghost btn-sm" onclick="sendCmd('train help')">Train Help</button>
        <button class="btn btn-success btn-sm" onclick="sendCmd('train on')">Train On</button>
        <button class="btn btn-danger btn-sm" onclick="sendCmd('train off')">Train Off</button>
      </div>
      <div class="text-muted" style="font-size:0.85em">These commands require trainer or root admin role.</div>
    </div>
    <div class="card">
      <h3>Focus Topic</h3>
      <div style="display:flex;gap:8px">
        <input id="focusInput" class="form-input" placeholder="Enter a focus topic..." style="flex:1"/>
        <button class="btn btn-accent btn-sm" onclick="sendFocus()">Set Focus</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Custom Command</h3>
    <div style="display:flex;gap:8px">
      <input id="customInput" class="form-input" placeholder="Enter any command..." style="flex:1"/>
      <button class="btn btn-accent btn-sm" onclick="sendCustom()">Send</button>
    </div>
  </div>

  <div class="card">
    <h3>Trainer Output</h3>
    <div class="log-box" id="trainerOutput" style="min-height:120px;max-height:320px">No commands sent yet.</div>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="showAuth()">Auth Status</button>
      <button class="btn btn-ghost btn-sm" onclick="pingNow()">Ping Session</button>
      <button class="btn btn-ghost btn-sm" onclick="clearOutput()">Clear</button>
    </div>
  </div>

  <div class="card">
    <h3>Live Learning</h3>
    <p class="text-muted" style="margin-bottom:12px">Real-time view of learning sessions and statistics.</p>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr))">
      <div>
        <h4 class="text-muted" style="margin-bottom:6px">Active Sessions</h4>
        <div id="learning-sessions" class="scroll-box" style="max-height:200px">Loading sessions...</div>
        <div id="learning-detail" class="scroll-box" style="max-height:300px;margin-top:8px;display:none">Select a session.</div>
      </div>
      <div>
        <h4 class="text-muted" style="margin-bottom:6px">Statistics</h4>
        <div id="learning-stats" class="scroll-box" style="max-height:200px">Loading stats...</div>
      </div>
    </div>
    <div style="margin-top:12px">
      <h4 class="text-muted" style="margin-bottom:6px">Summary</h4>
      <div id="learning-summary" class="log-box" style="max-height:150px">Loading summary...</div>
    </div>
    <div style="margin-top:12px">
      <h4 class="text-muted" style="margin-bottom:6px">Extended Research</h4>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <input id="extended-minutes" class="form-input" type="number" min="1" value="10" style="width:100px"/>
        <label class="text-muted" style="display:flex;align-items:center;gap:6px"><input id="extended-inference" type="checkbox"/> Enable inference</label>
        <button class="btn btn-accent btn-sm" onclick="startExtendedRun()">Start Extended Run</button>
      </div>
      <div id="extended-status" class="text-muted" style="margin-top:8px">No extended run active.</div>
    </div>
  </div>

  <div class="card">
    <h3>Background Runs</h3>
    <p class="text-muted" style="margin-bottom:8px">Active and recent extended learning runs.</p>
    <div id="background-runs" class="scroll-box" style="max-height:300px">Loading runs...</div>
    <div id="run-detail" class="scroll-box" style="display:none;margin-top:8px;max-height:250px"></div>
  </div>

  <div class="card">
    <h3>Proposals</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <label class="text-muted">Filter:</label>
      <select id="proposalFilter" class="form-input" onchange="renderProposals()" style="width:auto">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="applied">Applied</option>
        <option value="denied">Denied</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="loadProposals()">Refresh</button>
    </div>
    <div id="proposalsList" class="scroll-box" style="max-height:400px">Loading proposals...</div>
  </div>
</div>

<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
JeebsNav.init('trainer');

function escapeHtml(s){if(!s)return"";return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}

(async function(){
    var authStatusEl=document.getElementById("authStatus");
    var outputEl=document.getElementById("trainerOutput");
    var auth=await requireAuth("trainer");
    if(!auth||!auth.loggedIn){authStatusEl.innerHTML='<span style="color:var(--danger)">Access denied &mdash; please sign in as a trainer or admin.</span>';return;}
    authStatusEl.innerHTML='<span style="color:var(--accent)">Trainer access granted for <strong>'+escapeHtml(auth.username)+'</strong></span>';
    startSessionPing();startAuthGuard("trainer");

    function stamp(){return new Date().toLocaleTimeString();}
    function log(msg){
      var line="["+stamp()+"] "+msg;
      if(outputEl.textContent.trim()==="No commands sent yet."){outputEl.textContent=line;}
      else{outputEl.textContent+="\n"+line;}
      outputEl.scrollTop=outputEl.scrollHeight;
    }

    window.sendCmd=async function(cmd){
      log("Sending: "+cmd+"...");
      try{
        var res=await safeFetch("/api/chat",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",...authHeaders()},body:JSON.stringify({message:cmd})});
        var data=await res.json();
        if(!res.ok){log("Error: "+(data.error||res.statusText));return;}
        log(data.response||"No response received.");
      }catch(e){log("Request failed: "+e);}
    };

    window.sendFocus=function(){var f=document.getElementById("focusInput").value.trim();if(!f){log("Enter a focus topic.");return;}sendCmd("train: "+f);};
    window.sendCustom=function(){var c=document.getElementById("customInput").value.trim();if(!c){log("Enter a command.");return;}sendCmd(c);};
    window.clearOutput=function(){outputEl.textContent="No commands sent yet.";};

    window.showAuth=async function(){
      try{var res=await safeFetch("/api/auth/status",{credentials:"same-origin",headers:authHeaders()});var data=await res.json();
      if(!res.ok){log("Auth error: "+(data.error||res.statusText));return;}
      log("Auth: user="+(data.username||"?")+" admin="+data.is_admin+" trainer="+data.is_trainer);}
      catch(e){log("Auth failed: "+e);}
    };

    window.pingNow=async function(){
      try{var res=await safeFetch("/api/session/ping",{method:"POST",credentials:"same-origin",headers:authHeaders()});var data=await res.json();
      if(!res.ok){log("Ping error: "+(data.error||res.statusText));return;}
      log("Ping ok for "+(data.username||"?")+", last_seen="+(data.last_seen||"n/a"));}
      catch(e){log("Ping failed: "+e);}
    };

    // Proposals
    async function loadProposals(){
      try{var res=await safeFetch("/api/admin/evolution/updates",{credentials:"same-origin",headers:authHeaders()});
      if(!res.ok){document.getElementById("proposalsList").textContent="Failed to load proposals";return;}
      var data=await res.json();window._proposals=data.updates||[];renderProposals();}
      catch(e){document.getElementById("proposalsList").textContent="Error: "+e;}
    }

    window.renderProposals=function(){
      var filter=document.getElementById("proposalFilter").value;
      var el=document.getElementById("proposalsList");
      var updates=(window._proposals||[]).filter(function(u){return filter==="all"||u.status===filter;});
      if(!updates.length){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x1F4AD;</div><div>No proposals found.</div></div>';return;}
      el.innerHTML=updates.map(function(u){
        var title=(u.title||"Untitled").replace(/</g,"&lt;");
        var feeling=(u.feeling||"").toLowerCase();
        var icon=feeling==="like"?"\uD83D\uDC4D":feeling==="dislike"?"\uD83D\uDC4E":"";
        return '<div class="data-list-item" style="flex-direction:column;align-items:flex-start;padding:10px 0"><div style="font-weight:700">'+title+' '+icon+'</div><div class="text-muted" style="font-size:0.9em">'+escapeHtml(u.description||"")+'</div><div class="text-muted" style="font-size:0.85em">'+new Date(u.created_at).toLocaleString()+" &mdash; <strong>"+(u.status||"unknown")+"</strong></div></div>";
      }).join("");
    };
    window.loadProposals=loadProposals;
    loadProposals();

    // Live learning
    async function loadLearningSessions(){
      try{var res=await safeFetch("/api/learning/sessions",{credentials:"same-origin",headers:authHeaders()});
      var el=document.getElementById("learning-sessions");
      if(!res.ok){el.textContent="Failed to load sessions";return;}
      var payload=await res.json();var sessions=payload.sessions||[];
      if(!sessions.length){el.textContent="No learning sessions.";return;}
      el.innerHTML=sessions.map(function(s){
        return '<div class="data-list-item" style="cursor:pointer" data-session-id="'+escapeHtml(s.id||"")+'" onclick="window.loadLearningDetails(\''+escapeHtml(s.id||"")+'\')">'+'<div><strong>'+escapeHtml(s.topic)+'</strong> <span class="text-muted">('+escapeHtml(s.status)+')</span><br/><span class="text-muted" style="font-size:0.85em">Depth: '+s.depth_level+' &bull; Facts: '+s.facts_learned+' &bull; Problems: '+s.problems_added+'</span></div></div>';
      }).join("");}catch(e){var el=document.getElementById("learning-sessions");if(el)el.textContent="Error: "+e;}
    }

    async function loadLearningStats(){
      try{var res=await safeFetch("/api/learning/statistics",{credentials:"same-origin",headers:authHeaders()});
      var el=document.getElementById("learning-stats");
      if(!res.ok){el.textContent="Failed to load stats";return;}
      var payload=await res.json();var stats=payload.statistics||{};
      el.innerHTML=Object.keys(stats).map(function(k){return '<div class="data-list-item"><span>'+escapeHtml(k)+'</span><span>'+escapeHtml(String(stats[k]))+'</span></div>';}).join("");}
      catch(e){var el=document.getElementById("learning-stats");if(el)el.textContent="Error: "+e;}
    }

    async function loadLearningSummary(){
      try{var res=await safeFetch("/api/learning/summary",{credentials:"same-origin",headers:authHeaders()});
      var el=document.getElementById("learning-summary");
      if(!res.ok){el.textContent="Failed to load summary";return;}
      var payload=await res.json();el.textContent=payload.summary||"(no summary)";}
      catch(e){var el=document.getElementById("learning-summary");if(el)el.textContent="Error: "+e;}
    }

    await loadLearningSessions();await loadLearningStats();await loadLearningSummary();
    setInterval(loadLearningSessions,8000);setInterval(loadLearningStats,15000);setInterval(loadLearningSummary,30000);

    window.loadLearningDetails=async function(sessionId){
      var detailEl=document.getElementById("learning-detail");
      if(!sessionId){if(detailEl)detailEl.style.display="none";return;}
      detailEl.style.display="block";detailEl.textContent="Loading session...";
      try{var res=await safeFetch("/api/learning/session/"+encodeURIComponent(sessionId),{credentials:"same-origin",headers:authHeaders()});
      if(!res.ok){detailEl.textContent="Failed.";return;}
      var payload=await res.json();var s=payload.session;
      var facts=(s.learned_facts||[]).map(function(f){return '<div style="margin-bottom:8px"><strong>'+escapeHtml(f.fact)+'</strong><div class="text-muted" style="font-size:0.85em">Source: '+escapeHtml(f.source)+' &bull; Importance: '+f.importance+'</div></div>';}).join("");
      var problems=(s.practice_problems||[]).map(function(p){return '<div style="margin-bottom:8px"><strong>'+escapeHtml(p.problem)+'</strong> &mdash; '+escapeHtml(p.difficulty)+'<div class="text-muted" style="font-size:0.85em">Solved: '+p.solved+' &bull; Attempts: '+p.attempts+'</div></div>';}).join("");
      var connections=(s.connections_made||[]).map(function(c){return '<div style="margin-bottom:6px"><strong>'+escapeHtml(c.topic)+':</strong> '+escapeHtml(c.how_connected)+'</div>';}).join("");
      detailEl.innerHTML='<div style="font-weight:700;margin-bottom:8px">'+escapeHtml(s.topic)+' &mdash; '+escapeHtml(s.status)+' (depth '+s.depth_level+')</div><div class="text-muted" style="margin-bottom:12px">Last: '+escapeHtml(s.last_studied)+' &bull; Hours: '+s.study_hours+' &bull; Confidence: '+(s.confidence||0).toFixed(2)+'</div><h4>Facts</h4>'+(facts||'<div class="text-muted">No facts yet.</div>')+'<h4 style="margin-top:12px">Practice Problems</h4>'+(problems||'<div class="text-muted">No problems yet.</div>')+'<h4 style="margin-top:12px">Connections</h4>'+(connections||'<div class="text-muted">No connections yet.</div>');}
      catch(e){detailEl.textContent="Error: "+e;}
    };

    // Background runs
    async function loadBackgroundRuns(){
      try{var res=await safeFetch("/api/learning/extended-runs",{credentials:"same-origin",headers:authHeaders()});
      var el=document.getElementById("background-runs");
      if(!res.ok){el.textContent="Failed to load runs";return;}
      var payload=await res.json();var runs=payload.runs||[];
      if(!runs.length){el.textContent="No runs found.";return;}
      el.innerHTML=runs.map(function(r){
        var id=r.run_id||r.runId||"";var sess=r.session_id||"";var pct=Number(r.progress_percent||0).toFixed(0);var status=r.status||"";var started=r.started_at||r.startedAt||"";
        return '<div class="data-list-item"><div style="flex:1;min-width:0"><div style="font-weight:700">Run '+escapeHtml(id)+' <span class="text-muted">'+escapeHtml(status)+'</span></div><div class="text-muted" style="font-size:0.85em">Session: '+escapeHtml(sess)+' &bull; '+escapeHtml(started)+' &bull; '+pct+'%</div><div class="progress" style="margin-top:6px"><div class="progress-fill" style="width:'+pct+'%"></div></div></div><div style="display:flex;gap:4px;flex-shrink:0;margin-left:8px"><button class="btn btn-ghost btn-sm" onclick="showRun(\''+escapeHtml(id)+'\')">View</button><button class="btn btn-danger btn-sm" onclick="cancelRun(\''+escapeHtml(id)+'\')">Cancel</button></div></div>';
      }).join("");}catch(e){var el=document.getElementById("background-runs");if(el)el.textContent="Error: "+e;}
    }

    window.showRun=async function(id){
      try{var res=await safeFetch("/api/learning/extended-run/"+encodeURIComponent(id),{credentials:"same-origin",headers:authHeaders()});
      if(!res.ok){alert("Failed to load run");return;}
      var data=await res.json();var run=data.run;
      var el=document.getElementById("run-detail");if(!el)return;el.style.display="block";
      var hist=(run.history||[]).map(function(h){return '<div class="data-list-item"><span class="text-muted">'+escapeHtml(h.ts||"")+'</span><span>Progress: '+Math.round(h.progress_percent||0)+'% &bull; Facts: '+(h.facts_added_total||0)+'</span></div>';}).join("");
      el.innerHTML='<div style="font-weight:700;margin-bottom:8px">Run '+escapeHtml(run.run_id||run.runId||"")+'</div><div class="text-muted" style="margin-bottom:8px">Status: '+escapeHtml(run.status||"")+' &bull; Progress: '+Math.round(run.progress_percent||0)+'% &bull; Started: '+escapeHtml(run.started_at||"")+'</div><div style="display:flex;gap:6px;margin-bottom:12px"><button class="btn btn-danger btn-sm" onclick="cancelRun(\''+escapeHtml(run.run_id||run.runId||"")+'\')">Cancel</button></div><h4>History</h4>'+(hist||'<div class="text-muted">No history yet.</div>');}
      catch(e){alert("Error: "+e);}
    };

    window.cancelRun=async function(id){
      if(!confirm("Cancel run "+id+"?"))return;
      var res=await safeFetch("/api/learning/extended-run/"+encodeURIComponent(id)+"/cancel",{method:"POST",credentials:"same-origin",headers:authHeaders()});
      if(!res.ok){alert("Failed to cancel");return;}
      await loadBackgroundRuns();
    };

    await loadBackgroundRuns();setInterval(loadBackgroundRuns,8000);

    window.startExtendedRun=async function(){
      var minutes=Number(document.getElementById("extended-minutes").value)||10;
      var inference=!!document.getElementById("extended-inference").checked;
      var status=document.getElementById("extended-status");
      status.textContent="Starting extended run...";
      try{
        var selected=document.querySelector("#learning-sessions [data-session-id]");
        var sessionId=selected?selected.getAttribute("data-session-id"):null;
        if(!sessionId){alert("Select a learning session first.");status.textContent="No session selected.";return;}
        var res=await safeFetch("/api/learning/run-extended",{method:"POST",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({session_id:sessionId,minutes:minutes,inference:inference})});
        if(!res.ok){status.textContent="Failed to start.";return;}
        var data=await res.json();status.textContent=data.message||"Extended run started.";}
      catch(e){status.textContent="Error: "+e;}
    };
})();
</script>
</body>
</html>
