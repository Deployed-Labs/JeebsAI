<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jeebs Trainer Panel</title>
    <style>
        :root {
            --bg: #0f1117; --panel: #181c24; --panel-2: #1f2533;
            --text: #f6f8fb; --muted: #9da7bd; --accent: #7fffd4;
            --danger: #ff6b6b; --success: #8bc34a; --border: #2b3245;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: radial-gradient(circle at 10% 20%, #1c2234, #0f1117 45%),
                radial-gradient(circle at 80% 0%, #162036, #0f1117 40%), var(--bg);
            color: var(--text);
            font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            min-height: 100vh; padding: 24px 16px 64px;
        }
        .shell { max-width: 900px; margin: 0 auto; }
        header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
        h1 { margin: 0; font-size: 24px; color: var(--accent); }
        .nav-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-link {
            color: var(--text); text-decoration: none; padding: 8px 12px;
            background: var(--panel-2); border: 1px solid var(--border);
            border-radius: 8px; font-size: 14px; transition: all .15s ease;
        }
        .nav-link:hover { border-color: var(--accent); }
        .card {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 12px; padding: 18px; margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,.25);
        }
        .card h3 { margin: 0 0 12px; font-size: 16px; color: var(--text); }
        .muted { color: var(--muted); font-size: 13px; }
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input {
            background: var(--panel-2); border: 1px solid var(--border); color: var(--text);
            padding: 10px; border-radius: 8px; flex: 1; min-width: 200px;
        }
        .btn {
            border: 1px solid var(--border); background: var(--panel-2); color: var(--text);
            padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: all .15s ease;
        }
        .btn.accent { background: var(--accent); color: #0e1a1f; border-color: #9fffe3; }
        .btn.danger { background: var(--danger); color: #1a0f0f; border-color: #f8a3a3; }
        .btn.success { background: var(--success); color: #0f1a0f; border-color: #9ddf7f; }
        .btn:hover { transform: translateY(-1px); }
        .output {
            background: var(--panel-2); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; min-height: 120px; max-height: 320px;
            overflow: auto; font-family: ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 13px; white-space: pre-wrap; line-height: 1.5;
        }
        #authStatus {
            padding: 10px 14px; border-radius: 8px; margin-bottom: 16px;
            font-size: 14px; font-weight: 600;
            background: var(--panel-2); border: 1px solid var(--border);
        }
    </style>
</head>
<body>
<div class="shell">
    <header>
        <div>
            <h1>Trainer Panel</h1>
            <div class="muted">Training controls for trainers and admins.</div>
        </div>
        <div class="nav-links">
            <a class="nav-link" href="/webui/index.html">Home</a>
            <a class="nav-link" href="/webui/admin_dashboard.html">Admin Dashboard</a>
        </div>
    </header>

    <div id="authStatus">Checking access...</div>

    <div class="card">
        <h3>Quick Training Commands</h3>
        <div class="row" style="margin-bottom:12px">
            <button class="btn" onclick="sendCmd('train help')">Train Help</button>
            <button class="btn success" onclick="sendCmd('train on')">Train On</button>
            <button class="btn danger" onclick="sendCmd('train off')">Train Off</button>
        </div>
        <div class="muted">These commands require trainer or root admin role.</div>
    </div>

    <div class="card">
        <h3>Focus Topic</h3>
        <div class="row">
            <input id="focusInput" class="input" type="text" placeholder="Enter a focus topic..." />
            <button class="btn accent" onclick="sendFocus()">Set Focus</button>
        </div>
    </div>

    <div class="card">
        <h3>Custom Command</h3>
        <div class="row">
            <input id="customInput" class="input" type="text" placeholder="Enter any command..." />
            <button class="btn accent" onclick="sendCustom()">Send</button>
        </div>
    </div>

    <div class="card">
        <h3>Trainer Output</h3>
        <div class="output" id="trainerOutput">No commands sent yet.</div>
        <div class="row" style="margin-top:10px">
            <button class="btn" onclick="showAuth()">Show Auth Status</button>
            <button class="btn" onclick="pingNow()">Ping Session</button>
            <button class="btn" onclick="clearOutput()">Clear</button>
        </div>
    </div>

    <div class="card">
        <h3>Proposals</h3>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
            <label style="margin:0">Filter:</label>
            <select id="proposalFilter" onchange="renderProposals()">
                <option value="all">All</option>
                <option value="pending">Pending</option>
                <option value="applied">Applied</option>
                <option value="denied">Denied</option>
            </select>
            <button class="btn" onclick="loadProposals()">Refresh</button>
        </div>
        <div id="proposalsList" class="output">Loading proposals...</div>
    </div>
</div>

<script src="/webui/auth.js"></script>
<script>
(async () => {
    var authStatusEl = document.getElementById("authStatus");
    var outputEl = document.getElementById("trainerOutput");
    var auth = await requireAuth("trainer");
    if (!auth) return;
    authStatusEl.textContent = "Trainer access granted for " + auth.username + ".";
    // use defaults from auth.js (60s ping, longer guard) to reduce transient redirects
    startSessionPing();
    startAuthGuard("trainer");

    function stamp() { return new Date().toLocaleTimeString(); }

    function log(msg, isErr) {
        var line = "[" + stamp() + "] " + msg;
        if (outputEl.textContent.trim() === "No commands sent yet.") {
            outputEl.textContent = line;
        } else {
            outputEl.textContent += "\n" + line;
        }
        outputEl.scrollTop = outputEl.scrollHeight;
    }

    window.sendCmd = async function(cmd) {
        log("Sending: " + cmd + "...");
        try {
            var res = await safeFetch("/api/chat", {
                method: "POST", credentials: "same-origin",
                headers: { "Content-Type": "application/json", ...authHeaders() },
                body: JSON.stringify({ message: cmd }),
            });
            var data = await res.json();
            if (!res.ok) { log("Error: " + (data.error || res.statusText), true); return; }
            log(data.response || "No response received.");
        } catch (e) { log("Request failed: " + e, true); }
    };

    window.sendFocus = function() {
        var focus = document.getElementById("focusInput").value.trim();
        if (!focus) { log("Enter a focus topic before sending.", true); return; }
        sendCmd("train: " + focus);
    };

    window.sendCustom = function() {
        var cmd = document.getElementById("customInput").value.trim();
        if (!cmd) { log("Enter a command before sending.", true); return; }
        sendCmd(cmd);
    };

    window.clearOutput = function() { outputEl.textContent = "No commands sent yet."; };

    window.showAuth = async function() {
        try {
            var res = await safeFetch("/api/auth/status", { credentials: "same-origin", headers: authHeaders() });
            var data = await res.json();
            if (!res.ok) { log("Auth status error: " + (data.error || res.statusText), true); return; }
            log("Auth: user=" + (data.username||"?") + " admin=" + data.is_admin + " trainer=" + data.is_trainer);
        } catch (e) { log("Auth status failed: " + e, true); }
    };

    window.pingNow = async function() {
        try {
            var res = await safeFetch("/api/session/ping", { method: "POST", credentials: "same-origin", headers: authHeaders() });
            var data = await res.json();
            if (!res.ok) { log("Ping error: " + (data.error || res.statusText), true); return; }
            log("Ping ok for " + (data.username||"?") + ", last_seen=" + (data.last_seen||"n/a"));
        } catch (e) { log("Ping failed: " + e, true); }
    };

    // Proposals: load and render evolution proposals in a compact, readable list
    async function loadProposals() {
        try {
            const res = await safeFetch('/api/admin/evolution/updates', { credentials: 'same-origin', headers: authHeaders() });
            if (!res.ok) {
                document.getElementById('proposalsList').textContent = 'Failed to load proposals';
                return;
            }
            const data = await res.json();
            window._proposals = data.updates || [];
            renderProposals();
        } catch (e) {
            document.getElementById('proposalsList').textContent = 'Error loading proposals: ' + e;
        }
    }

    function renderProposals() {
        const filter = document.getElementById('proposalFilter').value;
        const listEl = document.getElementById('proposalsList');
        const updates = (window._proposals || []).filter(u => filter === 'all' ? true : u.status === filter);
        if (updates.length === 0) { listEl.textContent = 'No proposals found.'; return; }
        listEl.innerHTML = updates.map(u => {
            const title = (u.title || 'Untitled').replace(/</g,'&lt;');
            const feeling = (u.feeling || '').toLowerCase();
            const feelIcon = feeling === 'like' ? 'ðŸ‘' : feeling === 'dislike' ? 'ðŸ‘Ž' : feeling === 'neutral' ? 'ðŸ˜' : '';
            const desc = (u.description || '').replace(/</g,'&lt;');
            const when = new Date(u.created_at).toLocaleString();
            const status = (u.status || 'unknown');
            return `<div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.03);"><div style="font-weight:700">${title} <span style="margin-left:6px; font-size:1.1em">${feelIcon}</span></div><div style="opacity:.8; font-size:0.9em;">${desc}</div><div style="margin-top:6px; font-size:0.85em; color:#9da7bd">${when} â€” <strong>${status}</strong></div></div>`;
        }).join('');
    }

    // Load proposals after auth granted
    loadProposals();
})();
</script>
</body>
</html>
