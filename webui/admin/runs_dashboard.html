<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Runs Dashboard â€” JeebsAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="max-width:1000px;padding-top:60px">
  <h1 style="margin-bottom:24px">Background Runs Dashboard</h1>

  <div class="card card-glow">
    <div class="metrics-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr))">
      <div class="metric-card"><div id="metric-total" class="metric-value">-</div><div class="metric-label">Total Runs</div></div>
      <div class="metric-card"><div id="metric-running" class="metric-value">-</div><div class="metric-label">Running</div></div>
      <div class="metric-card"><div id="metric-cancelled" class="metric-value">-</div><div class="metric-label">Cancelled</div></div>
      <div class="metric-card"><div id="metric-avg" class="metric-value">-</div><div class="metric-label">Avg Progress</div></div>
    </div>
  </div>

  <div class="card">
    <h3>Recent Runs</h3>
    <div id="runs-list" class="scroll-box" style="max-height:50vh"><div class="text-muted" style="padding:20px;text-align:center">Loading...</div></div>
  </div>
</div>

<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
JeebsNav.init('trainer');

function escapeHtml(s){if(!s)return"";return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

async function loadDashboard(){
  var res=await safeFetch("/api/learning/extended-runs",{credentials:"same-origin",headers:authHeaders()});
  var el=document.getElementById("runs-list");
  if(!res.ok){el.textContent="Failed to load runs";return;}
  var data=await res.json();var runs=data.runs||[];
  document.getElementById("metric-total").textContent=runs.length;
  document.getElementById("metric-running").textContent=runs.filter(function(r){return(r.status||"").toString()==="running"}).length;
  document.getElementById("metric-cancelled").textContent=runs.filter(function(r){return r.cancelled===true}).length;
  var avg=runs.length?(runs.reduce(function(s,r){return s+Number(r.progress_percent||0)},0)/runs.length).toFixed(0):0;
  document.getElementById("metric-avg").textContent=avg+"%";
  if(!runs.length){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x1F3C3;</div><div>No runs found</div></div>';return;}
  el.innerHTML=runs.map(function(r){
    var id=r.run_id||"";var sess=r.session_id||"";var pct=Number(r.progress_percent||0).toFixed(0);var status=r.status||"";var started=r.started_at||"";
    return '<div class="data-list-item"><div style="flex:1;min-width:0"><div style="font-weight:700">'+escapeHtml(id)+' <span class="text-muted">'+escapeHtml(status)+'</span></div><div class="text-muted" style="font-size:0.85em">Session: '+escapeHtml(sess)+' &bull; '+escapeHtml(started)+' &bull; '+pct+'%</div><div class="progress" style="margin-top:6px"><div class="progress-fill" style="width:'+pct+'%"></div></div></div><button class="btn btn-ghost btn-sm" onclick="viewRun(\''+escapeHtml(id)+'\')">View</button></div>';
  }).join("");
}

async function viewRun(id){
  var res=await safeFetch("/api/learning/extended-run/"+encodeURIComponent(id),{credentials:"same-origin",headers:authHeaders()});
  if(!res.ok){alert("Failed to load run");return;}
  var data=await res.json();alert(JSON.stringify(data.run,null,2));
}

loadDashboard();setInterval(loadDashboard,8000);
</script>
</body>
</html>
