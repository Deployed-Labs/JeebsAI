<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>IP Whitelist â€” JeebsAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="max-width:640px;padding-top:60px">
  <h1 style="margin-bottom:4px">IP Whitelist</h1>
  <p class="text-muted" style="margin-bottom:24px">Whitelisted IPs bypass rate limiting</p>

  <div class="card" style="background:rgba(83,216,251,0.06);border-color:rgba(83,216,251,0.2);margin-bottom:16px">
    <p class="text-muted" style="margin:0;font-size:0.9em">Whitelisted IPs are exempt from the rate limiter. They can make unlimited API requests.</p>
  </div>

  <div class="card card-glow">
    <div id="status" class="text-muted" style="margin-bottom:8px;display:none"></div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <input id="ipInput" class="form-input" placeholder="Enter IP address (e.g. 10.0.0.1)" style="flex:1"/>
      <button class="btn btn-primary" onclick="addIP()">Add to Whitelist</button>
    </div>
    <div id="count" class="text-muted" style="margin-bottom:8px"></div>
    <div id="ipList" class="data-list"><div class="text-muted" style="padding:20px;text-align:center">Loading&hellip;</div></div>
  </div>
</div>

<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
JeebsNav.init('admin');

function escapeHtml(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML;}
function showStatus(msg,ok){var el=document.getElementById("status");el.textContent=msg;el.style.display="block";el.style.color=ok?"var(--accent)":"var(--danger)";setTimeout(function(){el.style.display="none"},3000);}

async function loadList(){
  try{
    var res=await safeFetch("/api/admin/whitelist",{credentials:"same-origin",headers:authHeaders()});
    if(!res.ok){document.getElementById("ipList").innerHTML='<div class="text-muted" style="padding:20px;text-align:center">Failed to load</div>';return;}
    var ips=await res.json();
    document.getElementById("count").textContent=ips.length+" whitelisted IP"+(ips.length!==1?"s":"");
    if(ips.length===0){document.getElementById("ipList").innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x1F310;</div><div>No whitelisted IPs</div></div>';return;}
    document.getElementById("ipList").innerHTML=ips.map(function(ip){
      return '<div class="data-list-item"><span style="font-family:var(--font-mono)'+escapeHtml(ip)+'</span><button class="btn btn-danger btn-sm" onclick="removeIP(\''+escapeHtml(ip)+'\')">Remove</button></div>';
    }).join("");
  }catch(e){document.getElementById("ipList").innerHTML='<div class="text-muted" style="padding:20px;text-align:center">Connection error</div>';}
}

async function addIP(){
  var ip=document.getElementById("ipInput").value.trim();if(!ip)return;
  var res=await safeFetch("/api/admin/whitelist",{method:"POST",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({ip:ip})});
  if(!res.ok){showStatus("Failed to add IP",false);return;}
  document.getElementById("ipInput").value="";showStatus("Whitelisted "+ip,true);loadList();
}

async function removeIP(ip){
  if(!confirm("Remove "+ip+" from whitelist?"))return;
  var res=await safeFetch("/api/admin/whitelist",{method:"DELETE",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({ip:ip})});
  if(!res.ok){showStatus("Failed to remove IP",false);return;}
  showStatus("Removed "+ip,true);loadList();
}

document.getElementById("ipInput").addEventListener("keydown",function(e){if(e.key==="Enter")addIP();});

// Access: allow 1090mb, admin, or trainer
(async function(){
  var auth=await requireAuth("admin");
  if(!auth||!(auth.username==="1090mb"||auth.is_admin||auth.is_trainer)){
    document.body.innerHTML = '<div class="shell" style="padding-top:60px"><h1>IP Whitelist</h1><div class="card" style="margin-top:32px"><span class="text-danger">Access denied. Only admin, trainer, or 1090mb allowed.</span></div></div>';
    return;
  }
  startAuthGuard("admin");
  loadList();
})();
</script>
</body>
</html>
