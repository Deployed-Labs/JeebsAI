<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Anomalies â€” JeebsAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/webui/style.css"/>
<style>
.anomaly-row{padding:12px;border-bottom:1px solid var(--border);font-size:0.9em}
.anomaly-row:last-child{border-bottom:none}
.anomaly-row .level-ERROR{color:var(--danger);font-weight:700}
.anomaly-row .level-WARN{color:var(--accent-2);font-weight:600}
</style>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="padding-top:60px">
  <h1 style="margin-bottom:4px">Anomalies</h1>
  <p class="text-muted" style="margin-bottom:24px">Recent entries flagged as anomalies. Admin only.</p>

  <div class="card" style="margin-bottom:16px">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary btn-sm" id="refresh">Refresh</button>
      <button class="btn btn-ghost btn-sm" id="export">Export CSV</button>
      <button class="btn btn-accent btn-sm" id="scan">Scan (sync)</button>
      <button class="btn btn-ghost btn-sm" id="scanAsync">Scan (background)</button>
    </div>
  </div>

  <div class="card">
    <div id="anomalies-list" class="scroll-box" style="max-height:70vh"><div class="text-muted" style="padding:20px;text-align:center">Loading&hellip;</div></div>
  </div>
</div>

<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
JeebsNav.init('admin');

function escapeHtml(s){return s?String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):"";}
function csvSafe(s){if(s==null)return"";var str=String(s).replace(/"/g,'""');if(str.includes(",")||str.includes("\n"))return'"'+str+'"';return str;}

async function fetchAnomalies(){
  var res=await safeFetch("/api/admin/anomalies",{credentials:"same-origin",headers:authHeaders()});
  if(!res.ok){alert("Failed to load anomalies.");return[];}
  return res.json();
}

function render(anoms){
  var el=document.getElementById("anomalies-list");
  if(!anoms.length){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x2714;</div><div>No anomalies detected</div></div>';return;}
  el.innerHTML=anoms.map(function(a){
    return '<div class="anomaly-row"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span class="text-muted" style="font-size:0.85em">#'+a.id+' &mdash; '+escapeHtml(a.timestamp)+'</span><span class="level-'+a.level+'">'+a.level+'</span></div><div style="margin-bottom:4px"><strong>['+escapeHtml(a.category)+']</strong> '+escapeHtml(a.message)+'</div>'+(a.reason?'<div class="text-muted" style="font-size:0.85em">Reason: '+escapeHtml(a.reason)+'</div>':'')+'</div>';
  }).join("");
}

document.getElementById("refresh").addEventListener("click",async function(){var a=await fetchAnomalies();render(a);});
document.getElementById("export").addEventListener("click",function(){
  safeFetch("/api/admin/anomalies",{credentials:"same-origin",headers:authHeaders()}).then(function(r){return r.json()}).then(function(data){
    var lines=["id,timestamp,level,category,message,reason"];
    for(var i=0;i<data.length;i++){var r=data[i];lines.push([r.id,csvSafe(r.timestamp),csvSafe(r.level),csvSafe(r.category),csvSafe(r.message),csvSafe(r.reason||"")].join(","));}
    var blob=new Blob([lines.join("\n")],{type:"text/csv"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="anomalies.csv";document.body.appendChild(a);a.click();a.remove();
  });
});

document.getElementById("scan").addEventListener("click",async function(){
  if(!confirm("Scan recent logs for anomalies?"))return;
  var res=await safeFetch("/api/admin/anomalies/scan",{method:"POST",credentials:"same-origin",headers:authHeaders()});
  if(!res.ok){alert("Scan failed");return;}
  var data=await res.json();alert("Scan finished. Flagged: "+(data.flagged||0));
  var a=await fetchAnomalies();render(a);
});

document.getElementById("scanAsync").addEventListener("click",async function(){
  if(!confirm("Start background scan?"))return;
  var res=await safeFetch("/api/admin/anomalies/scan?async=1",{method:"POST",credentials:"same-origin",headers:authHeaders()});
  if(!res.ok){alert("Failed to start scan");return;}
  var data=await res.json();var jobId=data.job_id;alert("Background scan started (job: "+jobId+")");
  var poll=setInterval(async function(){
    var r=await safeFetch("/api/admin/anomalies/scan/status/"+jobId,{credentials:"same-origin",headers:authHeaders()});
    if(!r.ok)return;var s=await r.json();
    if(s.status&&s.status.startsWith("done")){clearInterval(poll);alert("Scan complete: "+s.status);var a=await fetchAnomalies();render(a);}
  },3000);
});

(async function(){var auth=await requireAuth("admin");if(!auth)return;startAuthGuard("admin");var a=await fetchAnomalies();render(a);})();
</script>
</body>
</html>
