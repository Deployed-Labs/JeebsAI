<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin Dashboard — JeebsAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="padding-top:60px">
  <h1 style="margin-bottom:24px">Admin Dashboard</h1>

  <!-- System Status -->
  <div class="card card-glow">
    <h3>System Status</h3>
    <div id="systemStatus" class="data-list">
      <div class="data-list-item"><span>Server</span><span id="srvStatus" class="badge badge-accent">Checking...</span></div>
      <div class="data-list-item"><span>Uptime</span><span id="srvUptime" class="text-muted">—</span></div>
    </div>
  </div>

  <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(340px,1fr))">
    <!-- Feature Toggles -->
    <div class="card">
      <h3>Feature Toggles</h3>
      <div class="data-list">
        <div class="data-list-item">
          <span>Internet Access <span id="dotInternet" style="display:inline-block;width:10px;height:10px;border-radius:50%;margin-left:6px;background:#aaa;vertical-align:middle;"></span></span>
          <span id="toggleInternet" class="badge">—</span>
          <label class="switch" style="margin-left:16px;vertical-align:middle">
            <input type="checkbox" id="internetSwitch" onchange="onInternetSwitch()">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="data-list-item">
          <span>Training Mode <span id="dotTraining" style="display:inline-block;width:10px;height:10px;border-radius:50%;margin-left:6px;background:#aaa;vertical-align:middle;"></span></span>
          <span id="toggleTraining" class="badge">—</span>
          <label class="switch" style="margin-left:16px;vertical-align:middle">
            <input type="checkbox" id="trainingSwitch" onchange="onTrainingSwitch()">
            <span class="slider round"></span>
          </label>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <!-- Training toggle replaced by switch above -->
      </div>
    </div>

    <!-- Trainer Roles -->
    <div class="card">
      <h3>Trainer Roles</h3>
      <div id="trainerList" class="scroll-box" style="max-height:160px"><span class="text-muted">Loading...</span></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="trainerInput" class="form-input" placeholder="Username" style="flex:1"/>
        <button class="btn btn-accent btn-sm" onclick="addTrainer()">Add</button>
      </div>
    </div>
  </div>

  <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(340px,1fr))">
    <!-- Active Sessions -->
    <div class="card">
      <h3>Active Sessions</h3>
      <div id="sessionsList" class="scroll-box" style="max-height:220px"><span class="text-muted">Loading...</span></div>
    </div>

    <!-- Users -->
    <div class="card">
      <h3>Users</h3>
      <div id="usersList" class="scroll-box" style="max-height:220px"><span class="text-muted">Loading...</span></div>
    </div>
  </div>

  <!-- Server Logs -->
  <div class="card">
    <h3>Recent Logs</h3>
    <div id="recentLogs" class="log-box" style="max-height:260px">Loading...</div>
    <div style="margin-top:8px;text-align:right"><a href="/webui/logs.html" class="btn btn-ghost btn-sm">View All Logs &rarr;</a></div>
  </div>

  <!-- Backups -->
  <div class="card">
    <h3>Backups</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary btn-sm" onclick="exportData()">Export Data</button>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importFile').click()">Import Data</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)"/>
    </div>
  </div>

  <!-- Quick Links -->
  <div class="card">
    <h3>Quick Links</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px">
      <a href="/webui/evolution.html" class="link-tile"><span class="link-tile-label">Evolution</span></a>
      <a href="/webui/logs.html" class="link-tile"><span class="link-tile-label">Logs</span></a>
      <a href="/webui/trainer_panel.html" class="link-tile"><span class="link-tile-label">Trainer</span></a>
      <a href="/webui/admin_blacklist.html" class="link-tile"><span class="link-tile-label">Blacklist</span></a>
      <a href="/webui/admin_whitelist.html" class="link-tile"><span class="link-tile-label">Whitelist</span></a>
      <a href="/webui/admin_anomalies.html" class="link-tile"><span class="link-tile-label">Anomalies</span></a>
      <a href="/webui/admin_reasoning.html" class="link-tile"><span class="link-tile-label">Reasoning</span></a>
      <a href="/webui/visualize.html" class="link-tile"><span class="link-tile-label">Brain Graph</span></a>
    </div>
  </div>

  <!-- Training Controls -->
  <div class="card">
    <!-- Training controls removed: only available in Trainer Panel -->
  </div>
</div>

<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
// Toggle switch style
const style = document.createElement('style');
style.innerHTML = `
.switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #2ecc40; }
input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 24px; }
.slider.round:before { border-radius: 50%; }
`;
document.head.appendChild(style);

JeebsNav.init('admin');

function escapeHtml(s){if(!s)return"";return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

async function loadStatus(){
  try{
    const res=await safeFetch("/health");
    if(res.ok){const d=await res.json();document.getElementById("srvStatus").textContent=d.status.toUpperCase();document.getElementById("srvStatus").className="badge "+(d.status==="ok"?"badge-success":"badge-danger");}
  }catch(e){}
  try{
    const res=await safeFetch("/api/admin/status",{credentials:"same-origin",headers:authHeaders()});
    if(res.ok){const d=await res.json();document.getElementById("srvUptime").textContent=d.uptime||"—";}
  }catch(e){}
}

async function loadToggles(){
  // Load and display the current state of Internet and Training toggles
  try{
    const res=await safeFetch("/api/admin/internet/status",{credentials:"same-origin",headers:authHeaders()});
    if(res.ok){
      const d=await res.json();
      const el=document.getElementById("toggleInternet");
      el.textContent=d.enabled?"ON":"OFF";
      el.className="badge "+(d.enabled?"badge-success":"badge-danger");
      el.dataset.enabled = d.enabled ? "1" : "0";
      // Indicator dot
      const dot=document.getElementById("dotInternet");
      dot.style.background=d.enabled?"#2ecc40":"#e74c3c";
      dot.title=d.enabled?"Internet enabled":"Internet disabled";
      // Set switch state
      const sw=document.getElementById("internetSwitch");
      if(sw) sw.checked = !!d.enabled;
    }
  }catch(e){}
  function onInternetSwitch() {
    const sw = document.getElementById("internetSwitch");
    if (!sw) return;
    toggleFeature('internet', sw.checked);
  }
  try{
    const res=await safeFetch("/api/admin/training/status",{credentials:"same-origin",headers:authHeaders()});
    if(res.ok){
      const d=await res.json();
      const t=d.training||{};
      const el=document.getElementById("toggleTraining");
      el.textContent=t.enabled?"ON":"OFF";
      el.className="badge "+(t.enabled?"badge-success":"badge-danger");
      el.dataset.enabled = t.enabled ? "1" : "0";
      // Indicator dot
      const dot=document.getElementById("dotTraining");
      dot.style.background=t.enabled?"#2ecc40":"#e74c3c";
      dot.title=t.enabled?"Training enabled":"Training disabled";
    }
  }catch(e){}
}

async function toggleFeature(feat,on){
  // Toggle logic for Internet and Training
  if(feat==='internet'){
    // Optimistically update UI immediately
    const el=document.getElementById("toggleInternet");
    const dot=document.getElementById("dotInternet");
    el.textContent=on?"ON":"OFF";
    el.className="badge "+(on?"badge-success":"badge-danger");
    el.dataset.enabled = on ? "1" : "0";
    dot.style.background=on?"#2ecc40":"#e74c3c";
    dot.title=on?"Internet enabled":"Internet disabled";
    // Send request
    await safeFetch("/api/admin/internet/set",{
      method:"POST",
      credentials:"same-origin",
      headers:authHeaders(true),
      body:JSON.stringify({enabled:on})
    });
  } else if(feat==='training') {
    // Optimistically update UI immediately
    const el=document.getElementById("toggleTraining");
    const dot=document.getElementById("dotTraining");
    el.textContent=on?"ON":"OFF";
    el.className="badge "+(on?"badge-success":"badge-danger");
    el.dataset.enabled = on ? "1" : "0";
    dot.style.background=on?"#2ecc40":"#e74c3c";
    dot.title=on?"Training enabled":"Training disabled";
    // Send request
    await safeFetch("/api/admin/training/mode",{
      method:"POST",
      credentials:"same-origin",
      headers:authHeaders(true),
      body:JSON.stringify({enabled:on})
    });
  }
  // After toggling, reload toggle states and indicators (in case backend state differs)
  loadToggles();
}

// ENFORCEMENT LOGIC (for backend, but documented here for clarity):
// - If Training is OFF: No training can occur anywhere (trainers, background, or JeebsAI itself)
// - If Internet is OFF: JeebsAI cannot access the internet for any reason
// - If Internet is ON and Training is OFF: JeebsAI can autonomously browse/gather info for its brain, but no explicit training by trainers
// - If Training is ON: Trainers can train JeebsAI, and JeebsAI can also learn autonomously if internet is ON

async function loadSessions(){
  try{
    const res=await safeFetch("/api/admin/sessions",{credentials:"same-origin",headers:authHeaders()});
    const el=document.getElementById("sessionsList");
    if(!res.ok){el.innerHTML='<span class="text-muted">Access denied.</span>';return;}
    const sessions=await res.json();
    if(!sessions.length){el.innerHTML='<span class="text-muted">No active sessions.</span>';return;}
    el.innerHTML=sessions.map(function(s){
      return '<div class="data-list-item"><div><strong>'+escapeHtml(s.username)+'</strong> <span class="text-muted">'+escapeHtml(s.ip)+'</span><br/><span class="text-muted" style="font-size:0.8em">Last: '+new Date(s.last_seen).toLocaleString()+'</span></div><button class="btn btn-danger btn-sm" onclick="endSession(\''+escapeHtml(s.username)+'\')">End</button></div>';
    }).join("");
  }catch(e){document.getElementById("sessionsList").innerHTML='<span class="text-muted">Error.</span>';}
}

async function endSession(u){
  if(!confirm("End session for "+u+"?"))return;
  await safeFetch("/api/admin/session/"+encodeURIComponent(u),{method:"DELETE",credentials:"same-origin",headers:authHeaders()});
  loadSessions();
}

async function loadUsers(){
  try{
    const res=await safeFetch("/api/admin/users",{credentials:"same-origin",headers:authHeaders()});
    const el=document.getElementById("usersList");
    if(!res.ok){el.innerHTML='<span class="text-muted">Access denied.</span>';return;}
    const users=await res.json();
    el.innerHTML=users.map(function(u){
      return '<div class="data-list-item"><span>'+escapeHtml(u.username||u)+'</span><span class="badge badge-accent">'+(u.role||"user")+'</span></div>';
    }).join("");
  }catch(e){}
}

async function loadTrainers(){
  try{
    const res=await safeFetch("/api/admin/users",{credentials:"same-origin",headers:authHeaders()});
    const el=document.getElementById("trainerList");
    if(!res.ok){el.innerHTML='<span class="text-muted">Access denied.</span>';return;}
    const users=await res.json();
    const trainers=users.filter(function(u){return u.role==='trainer'||u.role==='admin';});
    if(!trainers.length){el.innerHTML='<span class="text-muted">No trainers.</span>';return;}
    el.innerHTML=trainers.map(function(t){
      return '<div class="data-list-item"><span>'+escapeHtml(t.username)+'</span><span class="badge">'+(t.role)+'</span></div>';
    }).join("");
  }catch(e){}
}

async function addTrainer(){
  var u=document.getElementById("trainerInput").value.trim();
  if(!u)return;
  await safeFetch("/api/admin/users/"+encodeURIComponent(u)+"/role",{method:"POST",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({role:"trainer"})});
  document.getElementById("trainerInput").value="";
  loadTrainers();
}

async function loadLogs(){
  try{
    const res=await safeFetch("/api/admin/logs?limit=20",{credentials:"same-origin",headers:authHeaders()});
    const el=document.getElementById("recentLogs");
    if(!res.ok){el.textContent="Access denied.";return;}
    const logs=await res.json();
    el.innerHTML=logs.slice().reverse().map(function(l){
      var cls=l.level==='ERROR'?'color:var(--danger)':l.level==='WARN'?'color:var(--accent-2)':'';
      return '<div style="'+cls+'"><span class="text-muted">['+escapeHtml(l.timestamp)+']</span> <strong>['+escapeHtml(l.category)+']</strong> '+escapeHtml(l.message)+'</div>';
    }).join("");
  }catch(e){document.getElementById("recentLogs").textContent="Error loading logs.";}
}

async function exportData(){
  window.location.href="/api/admin/export";
}

async function importData(input){
  if(!input.files.length)return;
  var formData=new FormData();formData.append("file",input.files[0]);
  var res=await safeFetch("/api/admin/import",{method:"POST",credentials:"same-origin",headers:{Authorization:"Bearer "+jeebsGetToken()},body:formData});
  alert(res.ok?"Import successful!":"Import failed.");
  input.value="";
}

async function loadTrainingStatus(){
  try{
    const res=await safeFetch('/api/admin/training/status');
    if(!res.ok){document.getElementById('training-status').textContent='Training status unavailable';return;}
    const d=await res.json();
    const t=d.training||{};
    document.getElementById('training-status').textContent='Training: '+(t.enabled?'ON':'OFF')+(t.status?(' | '+t.status):'');
  }catch(e){document.getElementById('training-status').textContent='Training status error';}
}

async function setTrainingMode(on){
  try{
    await safeFetch('/api/admin/training/mode',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:on})});
    loadTrainingStatus();
    logTraining('Training mode set to '+(on?'ON':'OFF'));
  }catch(e){logTraining('Failed to set training mode');}
}

async function runTrainingNow(){
  logTraining('Starting training session...');
  try{
    const res=await safeFetch('/api/admin/training/run',{method:'POST'});
    if(!res.ok){logTraining('Training failed to start');return;}
    const d=await res.json();
    logTraining('Training started: '+(d.status||'in progress'));
    if(d.topic||d.subject||d.learning){
      logTraining('JeebsAI is now studying: '+(d.topic||d.subject||d.learning));
    }
    pollTrainingLog();
  }catch(e){logTraining('Training error');}
}

function logTraining(msg){
  const log=document.getElementById('training-log');
  log.textContent=msg+'\n'+log.textContent;
}

async function pollTrainingLog(){
  // Poll backend for training log/status every 5s
  for(let i=0;i<60;i++){ // 5 min minimum
    await new Promise(r=>setTimeout(r,5000));
    try{
      const res=await safeFetch('/api/admin/training/status');
      if(!res.ok)continue;
      const d=await res.json();
      if(d.training){
        if(d.training.learning||d.training.topic||d.training.subject){
          logTraining('JeebsAI is studying: '+(d.training.learning||d.training.topic||d.training.subject));
        }
        if(d.training.log){
          logTraining(d.training.log);
        }
        if(d.training.status==='done'){
          logTraining('Training complete.');
          break;
        }
      }
    }catch(e){logTraining('Training log error');}
  }
}

(async function(){
  var auth=await requireAuth("admin");
  if(!auth)return;
  startAuthGuard("admin");
  loadStatus();loadToggles();loadSessions();loadUsers();loadTrainers();loadLogs();loadTrainingStatus();
  setInterval(loadStatus,15000);
  setInterval(loadSessions,20000);
  setInterval(loadTrainingStatus,10000);
})();
</script>
</body>
</html>
