<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Jeebs Admin Dashboard</title>
        <style>
            :root {
                --bg: #0f1117;
                --panel: #181c24;
                --panel-2: #1f2533;
                --text: #f6f8fb;
                --muted: #9da7bd;
                --accent: #7fffd4;
                --danger: #ff6b6b;
                --success: #8bc34a;
                --border: #2b3245;
            }
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                background: radial-gradient(circle at 10% 20%, #1c2234, #0f1117 45%),
                    radial-gradient(circle at 80% 0%, #162036, #0f1117 40%),
                    var(--bg);
                color: var(--text);
                font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
                min-height: 100vh;
                padding: 24px 16px 64px;
            }
            .shell {
                max-width: 1200px;
                margin: 0 auto;
            }
            header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 16px;
                margin-bottom: 24px;
            }
            h1 {
                margin: 0;
                font-size: 26px;
                letter-spacing: 0.3px;
                color: var(--accent);
            }
            .nav-links {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            .nav-link {
                color: var(--text);
                text-decoration: none;
                padding: 8px 12px;
                background: var(--panel-2);
                border: 1px solid var(--border);
                border-radius: 8px;
                transition: all 0.15s ease;
                font-size: 14px;
            }
            .nav-link:hover {
                border-color: var(--accent);
                transform: translateY(-1px);
            }
            .grid {
                display: grid;
                gap: 16px;
            }
            .grid.cols-2 {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            .grid.cols-3 {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            }
            .card {
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 18px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            }
            .card h3 {
                margin: 0 0 12px;
                font-size: 16px;
                letter-spacing: 0.2px;
                color: var(--text);
            }
            .muted {
                color: var(--muted);
                font-size: 13px;
            }
            .badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 10px;
                border-radius: 999px;
                font-size: 13px;
                font-weight: 600;
                border: 1px solid var(--border);
                background: var(--panel-2);
            }
            .badge.success {
                color: var(--success);
                border-color: #335c2d;
            }
            .badge.danger {
                color: var(--danger);
                border-color: #613138;
            }
            .btn {
                border: 1px solid var(--border);
                background: var(--panel-2);
                color: var(--text);
                padding: 10px 14px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.15s ease;
            }
            .btn.accent {
                background: var(--accent);
                color: #0e1a1f;
                border-color: #9fffe3;
            }
            .btn.success { background: var(--success); color: #0f1a0f; border-color: #9ddf7f; }
            .btn.danger { background: var(--danger); color: #1a0f0f; border-color: #f8a3a3; }
            .btn:disabled { opacity: 0.5; cursor: not-allowed; }
            .btn:hover:not(:disabled) { transform: translateY(-1px); }
            .stack { display: flex; flex-direction: column; gap: 8px; }
            .row { display: flex; gap: 10px; align-items: center; }
            .input {
                background: var(--panel-2);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 10px;
                border-radius: 8px;
                width: 100%;
            }
            .list {
                background: var(--panel-2);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 10px;
                max-height: 220px;
                overflow: auto;
                font-size: 13px;
            }
            .log-list { font-family: ui-monospace, SFMono-Regular, Consolas, monospace; }
            .spacer { flex: 1; }
            .pill {
                padding: 6px 10px;
                border-radius: 999px;
                background: var(--panel-2);
                border: 1px solid var(--border);
                font-size: 12px;
                color: var(--muted);
            }
            .link-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 10px;
                margin-top: 12px;
            }
            .link-tile {
                background: var(--panel-2);
                border: 1px solid var(--border);
                padding: 12px;
                border-radius: 10px;
                text-decoration: none;
                color: var(--text);
                font-size: 14px;
                transition: all 0.15s ease;
            }
            .link-tile:hover { border-color: var(--accent); transform: translateY(-1px); }
            .footer-link { display: inline-block; margin-top: 18px; color: var(--accent); text-decoration: none; }
        </style>
    </head>
    <body>
        <div class="shell">
            <header>
                <div>
                    <h1>Jeebs Admin</h1>
                    <div class="muted">Root admin controls for status, sessions, training, and backups.</div>
                </div>
                <div class="nav-links">
                    <a class="nav-link" href="/webui/index.html">← Home</a>
                    <a class="nav-link" href="/webui/trainer_panel.html">Trainer Panel</a>
                    <a class="nav-link" href="/webui/evolution.html">Evolution</a>
                    <a class="nav-link" href="/webui/logs.html">Advanced Logs</a>
                </div>
            </header>

            <div class="grid cols-2" style="margin-bottom: 16px">
                <div class="card" id="systemStatus">
                    <div class="row" style="justify-content: space-between">
                        <h3>System Status</h3>
                        <span class="pill" id="uptimePill">Uptime: --</span>
                    </div>
                    <div class="muted" id="statusContent">Loading status...</div>
                </div>

                <div class="card">
                    <div class="row" style="justify-content: space-between; gap: 12px">
                        <div>
                            <h3 style="margin-bottom: 6px">Toggles</h3>
                            <div class="muted">Control internet and training mode.</div>
                        </div>
                        <div class="row" style="gap: 8px">
                            <span id="internetBadge" class="badge">Internet: --</span>
                            <span id="trainingBadge" class="badge">Training: --</span>
                        </div>
                    </div>
                    <div class="row" style="gap: 8px; margin-top: 12px">
                        <button class="btn" id="internetToggleBtn">Toggle Internet</button>
                        <button class="btn" id="trainingToggleBtn">Toggle Training</button>
                        <div class="muted spacer" style="text-align: right" id="intervalInfo"></div>
                    </div>
                </div>
            </div>

            <div class="grid cols-2" style="margin-bottom: 16px">
                <div class="card">
                    <h3>Trainer Roles</h3>
                    <div class="row" style="gap: 8px; margin-bottom: 8px; flex-wrap: wrap">
                        <input id="trainerUsername" class="input" type="text" placeholder="Username" />
                        <button class="btn accent" id="makeTrainerBtn">Make Trainer</button>
                        <button class="btn" id="removeTrainerBtn">Remove Trainer</button>
                    </div>
                    <div class="muted" id="trainerRoleStatus"></div>
                    <div class="muted" id="trainerList" style="margin-top: 10px">Loading trainers...</div>
                </div>

                <div class="card">
                    <h3>Active Sessions</h3>
                    <div class="list" id="sessionsContent">Loading sessions...</div>
                </div>
            </div>

            <div class="grid cols-2" style="margin-bottom: 16px">
                <div class="card">
                    <div class="row" style="justify-content: space-between; align-items: center">
                        <h3>Server Logs</h3>
                        <button class="btn" id="refreshLogsBtn">Refresh</button>
                    </div>
                    <div class="list log-list" id="logsContent">Loading logs...</div>
                </div>

                <div class="card">
                    <h3>Backups</h3>
                    <div class="stack">
                        <a class="btn accent" href="/api/admin/export" target="_blank">Export Database (JSON)</a>
                        <label class="btn" style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer; justify-content: center">
                            <input type="file" id="importFile" accept=".json" style="display: none" />
                            Import Database (JSON)
                        </label>
                        <div class="muted">Imports overwrite existing data. Use with care.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Quick Links</h3>
                <div class="link-grid">
                    <a class="link-tile" href="/webui/search.html">Brain Search</a>
                    <a class="link-tile" href="/webui/visualize.html">Brain Visualization</a>
                    <a class="link-tile" href="/webui/logic_visualize.html">Logic Graph</a>
                    <a class="link-tile" href="/webui/admin_blacklist.html">IP Blacklist</a>
                    <a class="link-tile" href="/webui/admin_whitelist.html">IP Whitelist</a>
                </div>
            </div>
        </div>

        <script>
            const ROOT_ADMIN_USERNAME = "1090mb";
            const TOKEN_KEY = "jeebs_auth_token";
            let rootAdminAuthorized = false;
            let refreshTimer = null;

            const internetBadge = document.getElementById("internetBadge");
            const trainingBadge = document.getElementById("trainingBadge");
            const internetToggleBtn = document.getElementById("internetToggleBtn");
            const trainingToggleBtn = document.getElementById("trainingToggleBtn");
            const statusContent = document.getElementById("statusContent");
            const uptimePill = document.getElementById("uptimePill");
            const logsContent = document.getElementById("logsContent");
            const sessionsContent = document.getElementById("sessionsContent");
            const trainerList = document.getElementById("trainerList");
            const trainerRoleStatus = document.getElementById("trainerRoleStatus");
            const intervalInfo = document.getElementById("intervalInfo");

            function authHeaders(json = false) {
                const h = json ? { "Content-Type": "application/json" } : {};
                const token = localStorage.getItem(TOKEN_KEY);
                if (token) h["Authorization"] = `Bearer ${token}`;
                return h;
            }

            async function ensureRootAdmin() {
                const headers = authHeaders();
                const res = await fetch("/api/auth/status", { headers, credentials: "same-origin" });
                if (!res.ok) return false;
                const auth = await res.json();
                const ok = auth.logged_in && auth.is_admin && auth.username === ROOT_ADMIN_USERNAME;
                return !!ok;
            }

            function startAutoRefresh() {
                if (refreshTimer) return;
                refreshTimer = setInterval(() => {
                    void loadStatus();
                    void loadInternet();
                    void loadTraining();
                    void loadSessions();
                    void loadTrainerList();
                    void loadLogs();
                }, 8000);
            }

            async function loadStatus() {
                if (!rootAdminAuthorized) return;
                try {
                    const res = await fetch("/api/admin/status", { headers: authHeaders() });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    const usedMb = Number(data.used_memory_mb ?? (data.used_memory || 0) / 1024 / 1024);
                    const totalMb = Number(data.total_memory_mb ?? (data.total_memory || 1) / 1024 / 1024);
                    const pct = totalMb > 0 ? (usedMb / totalMb) * 100 : 0;
                    uptimePill.textContent = `Uptime: ${data.uptime_formatted || "--"}`;
                    statusContent.innerHTML = `Memory: ${usedMb.toFixed(1)} MB / ${totalMb.toFixed(1)} MB (${pct.toFixed(1)}%)<br/>Available: ${(data.available_memory_mb ?? 0).toFixed(1)} MB`;
                } catch (err) {
                    statusContent.textContent = `Status unavailable: ${err}`;
                }
            }

            async function loadInternet() {
                try {
                    const res = await fetch("/api/admin/internet/status", { headers: authHeaders() });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    const enabled = !!data.enabled;
                    internetBadge.textContent = `Internet: ${enabled ? "ENABLED" : "DISABLED"}`;
                    internetBadge.className = `badge ${enabled ? "success" : "danger"}`;
                    internetToggleBtn.textContent = enabled ? "Disable" : "Enable";
                    return enabled;
                } catch (err) {
                    internetBadge.textContent = "Internet: error";
                    internetBadge.className = "badge danger";
                    return null;
                }
            }

            async function toggleInternet() {
                internetToggleBtn.disabled = true;
                const current = await loadInternet();
                if (current === null) {
                    internetToggleBtn.disabled = false;
                    return;
                }
                const next = !current;
                try {
                    const res = await fetch("/api/admin/internet/set", {
                        method: "POST",
                        headers: authHeaders(true),
                        body: JSON.stringify({ enabled: next }),
                    });
                    if (!res.ok) throw new Error(await res.text());
                } catch (err) {
                    alert(`Failed to toggle internet: ${err}`);
                }
                await loadInternet();
                internetToggleBtn.disabled = false;
            }

            async function loadTraining() {
                try {
                    const res = await fetch("/api/admin/training/status", { headers: authHeaders() });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    const enabled = data.training?.enabled === true;
                    trainingBadge.textContent = `Training: ${enabled ? "RUNNING" : "STOPPED"}`;
                    trainingBadge.className = `badge ${enabled ? "success" : "danger"}`;
                    trainingToggleBtn.textContent = enabled ? "Stop Training" : "Start Training";
                    if (data.interval_seconds) {
                        intervalInfo.textContent = `Interval: ${data.interval_seconds}s`;
                    } else {
                        intervalInfo.textContent = "";
                    }
                    return enabled;
                } catch (err) {
                    trainingBadge.textContent = "Training: error";
                    trainingBadge.className = "badge danger";
                    intervalInfo.textContent = "";
                    return null;
                }
            }

            async function toggleTraining() {
                trainingToggleBtn.disabled = true;
                const current = await loadTraining();
                if (current === null) {
                    trainingToggleBtn.disabled = false;
                    return;
                }
                const next = !current;
                try {
                    const res = await fetch("/api/admin/training/mode", {
                        method: "POST",
                        headers: authHeaders(true),
                        body: JSON.stringify({ enabled: next }),
                    });
                    if (!res.ok) throw new Error(await res.text());
                } catch (err) {
                    alert(`Failed to toggle training: ${err}`);
                }
                await loadTraining();
                trainingToggleBtn.disabled = false;
            }

            async function loadTrainerList() {
                try {
                    const res = await fetch("/api/admin/users", { headers: authHeaders() });
                    if (!res.ok) throw new Error(await res.text());
                    const users = await res.json();
                    const trainers = users.filter((u) => u.role === "trainer").map((u) => u.username);
                    trainerList.textContent = trainers.length ? `Trainers: ${trainers.join(", ")}` : "No trainers assigned.";
                } catch (err) {
                    trainerList.textContent = `Trainer list error: ${err}`;
                }
            }

            async function updateTrainerRole(role) {
                const username = document.getElementById("trainerUsername").value.trim();
                if (!username) {
                    trainerRoleStatus.textContent = "Enter a username first.";
                    return;
                }
                trainerRoleStatus.textContent = `Updating ${username}...`;
                try {
                    const res = await fetch("/api/admin/user/role", {
                        method: "POST",
                        headers: authHeaders(true),
                        body: JSON.stringify({ username, role }),
                    });
                    if (!res.ok) throw new Error(await res.text());
                    trainerRoleStatus.textContent = `Role set: ${username} → ${role}`;
                    await loadTrainerList();
                } catch (err) {
                    trainerRoleStatus.textContent = `Failed: ${err}`;
                }
            }

            async function loadSessions() {
                try {
                    const res = await fetch("/api/admin/sessions", { headers: authHeaders() });
                    if (!res.ok) throw new Error(await res.text());
                    const sessions = await res.json();
                    if (!sessions.length) {
                        sessionsContent.textContent = "No active sessions.";
                        return;
                    }
                    sessionsContent.innerHTML = sessions
                        .map(
                            (s) => `<div class="row" style="justify-content: space-between; border-bottom: 1px solid var(--border); padding: 6px 2px;">
                                <span><strong>${s.username}</strong> (${s.ip})</span>
                                <span class="muted">${new Date(s.last_seen).toLocaleTimeString()}</span>
                                <button class="btn danger" onclick="terminateSession('${s.username}')">Terminate</button>
                            </div>`
                        )
                        .join("");
                } catch (err) {
                    sessionsContent.textContent = `Sessions error: ${err}`;
                }
            }

            async function terminateSession(username) {
                if (!confirm(`Terminate session for ${username}?`)) return;
                try {
                    const res = await fetch(`/api/admin/session/${username}`, { method: "DELETE", headers: authHeaders() });
                    if (!res.ok) throw new Error(await res.text());
                    await loadSessions();
                } catch (err) {
                    alert(`Failed to terminate: ${err}`);
                }
            }

            async function loadLogs() {
                try {
                    const res = await fetch("/api/admin/logs", { headers: authHeaders() });
                    if (!res.ok) throw new Error(await res.text());
                    const logs = await res.json();
                    const ordered = logs.slice().reverse();
                    if (!ordered.length) {
                        logsContent.textContent = "No logs captured yet.";
                        return;
                    }
                    logsContent.innerHTML = ordered
                        .map((l) => {
                            if (typeof l === "string") return l;
                            const ts = l.timestamp || "";
                            const cat = l.category || "LOG";
                            const lvl = l.level || "INFO";
                            const msg = l.message || JSON.stringify(l);
                            return `[${ts}] ${cat}/${lvl}: ${msg}`;
                        })
                        .join("\n");
                    logsContent.scrollTop = logsContent.scrollHeight;
                } catch (err) {
                    logsContent.textContent = `Logs error: ${err}`;
                }
            }

            function wireImport() {
                const input = document.getElementById("importFile");
                input.addEventListener("change", async () => {
                    if (!input.files || !input.files[0]) return;
                    const file = input.files[0];
                    if (!confirm(`Import ${file.name}? This overwrites existing data.`)) {
                        input.value = "";
                        return;
                    }
                    try {
                        const text = await file.text();
                        const json = JSON.parse(text);
                        const res = await fetch("/api/admin/import", {
                            method: "POST",
                            headers: authHeaders(true),
                            body: JSON.stringify(json),
                        });
                        if (!res.ok) throw new Error(await res.text());
                        alert("Import complete.");
                    } catch (err) {
                        alert(`Import failed: ${err}`);
                    }
                    input.value = "";
                });
            }

            async function init() {
                rootAdminAuthorized = await ensureRootAdmin();
                if (!rootAdminAuthorized) {
                    window.location.replace("/webui/index.html");
                    return;
                }

                internetToggleBtn.addEventListener("click", toggleInternet);
                trainingToggleBtn.addEventListener("click", toggleTraining);
                document.getElementById("makeTrainerBtn").addEventListener("click", () => updateTrainerRole("trainer"));
                document.getElementById("removeTrainerBtn").addEventListener("click", () => updateTrainerRole("user"));
                document.getElementById("refreshLogsBtn").addEventListener("click", () => void loadLogs());
                wireImport();

                await Promise.all([
                    loadStatus(),
                    loadInternet(),
                    loadTraining(),
                    loadTrainerList(),
                    loadSessions(),
                    loadLogs(),
                ]);

                startAutoRefresh();
            }

            init();
        </script>
    </body>
</html>
