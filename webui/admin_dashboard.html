<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Jeebs Admin Dashboard</title>
        <style>
            body {
                font-family: "Segoe UI", Arial, sans-serif;
                background: #181c24;
                color: #f3f3f3;
                margin: 0;
                padding: 20px;
            }
            .container {
                max-width: 900px;
                margin: 40px auto;
            }
            h1 {
                color: #7fffd4;
                text-align: center;
                margin-bottom: 40px;
            }
            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }
            .card {
                background: #23283a;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                transition:
                    transform 0.2s,
                    background 0.2s;
                text-decoration: none;
                color: inherit;
                display: block;
                border: 1px solid #2a3044;
            }
            .card:hover {
                transform: translateY(-5px);
                background: #2a3044;
                border-color: #7fffd4;
            }
            .card h3 {
                margin-top: 0;
                color: #7fffd4;
                font-size: 1.2rem;
            }
            .card p {
                color: #aaa;
                margin-bottom: 0;
                line-height: 1.5;
            }
            .back-link {
                display: block;
                margin-top: 40px;
                text-align: center;
                color: #7fffd4;
                text-decoration: none;
                opacity: 0.8;
            }
            .back-link:hover {
                text-decoration: underline;
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Admin Dashboard</h1>
            <div style="text-align: center; margin-bottom: 16px">
                <a
                    href="/webui/trainer_panel.html"
                    class="back-link"
                    style="margin-top: 0"
                >
                    üßë‚Äçüè´ Trainer Panel
                </a>
            </div>

            <div
                id="systemStatus"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #7fffd4;
                    text-align: center;
                "
            >
                <h3 style="margin-top: 0; color: #7fffd4">System Status</h3>
                <div id="statusContent">Loading...</div>
            </div>

            <div
                id="internetToggle"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #ff6b6b;
                    text-align: center;
                "
            >
                <h3 style="margin-top: 0; color: #ff6b6b">
                    üåê Internet Access
                </h3>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 15px;
                    "
                >
                    <div
                        id="internetStatus"
                        style="
                            font-size: 1.1em;
                            font-weight: bold;
                            color: #ff6b6b;
                        "
                    >
                        Loading...
                    </div>
                    <button
                        id="internetToggleBtn"
                        onclick="toggleInternet()"
                        style="
                            padding: 10px 20px;
                            background: #7fffd4;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            color: #181c24;
                            font-size: 14px;
                        "
                    >
                        TOGGLE
                    </button>
                </div>
                <div style="margin-top: 10px; color: #aaa; font-size: 0.9em">
                    Enable internet for training mode and web crawling
                </div>
            </div>

            <div
                id="trainingModeToggle"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #8bc34a;
                    text-align: center;
                "
            >
                <h3 style="margin-top: 0; color: #8bc34a">ü§ñ Training Mode</h3>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 15px;
                    "
                >
                    <div
                        id="trainingStatus"
                        style="
                            font-size: 1.1em;
                            font-weight: bold;
                            color: #8bc34a;
                        "
                    >
                        Loading...
                    </div>
                    <button
                        id="trainingToggleBtn"
                        onclick="toggleTrainingMode()"
                        style="
                            padding: 10px 20px;
                            background: #8bc34a;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            color: #181c24;
                            font-size: 14px;
                        "
                    >
                        TOGGLE
                    </button>
                </div>
                <div style="margin-top: 10px; color: #aaa; font-size: 0.9em">
                    Enable/disable automatic training cycles (learns from web &
                    chat)
                </div>
            </div>

            <div
                id="trainerRolePanel"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #7fffd4;
                "
            >
                <h3 style="margin-top: 0; color: #7fffd4; text-align: center">
                    üßë‚Äçüè´ Trainer Role Management
                </h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap">
                    <input
                        id="trainerUsername"
                        type="text"
                        placeholder="Username (e.g., alice)"
                        style="
                            flex: 1;
                            min-width: 200px;
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #444;
                            background: #181c24;
                            color: #f3f3f3;
                        "
                    />
                    <button
                        onclick="setTrainerRole('trainer')"
                        style="
                            padding: 10px 14px;
                            background: #7fffd4;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            color: #181c24;
                        "
                    >
                        Make Trainer
                    </button>
                    <button
                        onclick="setTrainerRole('user')"
                        style="
                            padding: 10px 14px;
                            background: #fbbf24;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            color: #181c24;
                        "
                    >
                        Remove Trainer
                    </button>
                </div>
                <div
                    id="trainerRoleStatus"
                    style="margin-top: 10px; color: #aaa; font-size: 0.9em"
                ></div>
                <div
                    id="trainerList"
                    style="margin-top: 10px; color: #ccc; font-size: 0.9em"
                ></div>
            </div>

            <div
                id="serverLogs"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #7fffd4;
                "
            >
                <h3 style="margin-top: 0; color: #7fffd4; text-align: center">
                    Server Logs
                </h3>
                <div
                    id="logsContent"
                    style="
                        background: #181c24;
                        padding: 10px;
                        border-radius: 6px;
                        height: 200px;
                        overflow-y: auto;
                        font-family: monospace;
                        font-size: 0.9em;
                        color: #ccc;
                    "
                >
                    Loading logs...
                </div>
            </div>

            <div
                id="sessionsBox"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #7fffd4;
                "
            >
                <h3 style="margin-top: 0; color: #7fffd4; text-align: center">
                    Active Sessions
                </h3>
                <div id="sessionsContent" style="color: #ccc; font-size: 0.9em">
                    Loading sessions...
                </div>
            </div>

            <div
                id="topicLearningBox"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #ffa500;
                "
            >
                <h3 style="margin-top: 0; color: #ffa500; text-align: center">
                    üéì Topic Learning
                </h3>
                <div
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        align-items: center;
                    "
                >
                    <input
                        type="text"
                        id="topicInput"
                        placeholder="Enter a topic (e.g. quantum computing, machine learning...)"
                        onkeypress="if (event.key === 'Enter') learnTopic();"
                        style="
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #ccc;
                            width: 70%;
                            font-size: 14px;
                        "
                    />
                    <button
                        onclick="learnTopic()"
                        style="
                            padding: 10px 20px;
                            background: #ffa500;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            color: #181c24;
                            font-size: 14px;
                        "
                    >
                        LEARN
                    </button>
                </div>
                <div
                    id="topicStatus"
                    style="
                        text-align: center;
                        margin-top: 10px;
                        color: #aaa;
                        font-size: 14px;
                    "
                ></div>
            </div>

            <div
                id="crawlerBox"
                style="
                    background: #23283a;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: 1px solid #7fffd4;
                "
            >
                <h3 style="margin-top: 0; color: #7fffd4; text-align: center">
                    Unleash Jeebs (Crawler)
                </h3>
                <div style="display: flex; gap: 10px; justify-content: center">
                    <input
                        type="text"
                        id="crawlUrl"
                        placeholder="Start URL (e.g. https://rust-lang.org)"
                        style="
                            padding: 8px;
                            border-radius: 4px;
                            border: 1px solid #ccc;
                            width: 60%;
                        "
                    />
                    <input
                        type="number"
                        id="crawlDepth"
                        placeholder="Depth (1-3)"
                        min="1"
                        max="3"
                        value="1"
                        style="
                            padding: 8px;
                            border-radius: 4px;
                            border: 1px solid #ccc;
                            width: 80px;
                        "
                    />
                    <button
                        onclick="startCrawl()"
                        style="
                            padding: 8px 16px;
                            background: #7fffd4;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            color: #181c24;
                        "
                    >
                        GO
                    </button>
                    <button
                        onclick="startRandomCrawl()"
                        style="
                            padding: 8px 16px;
                            background: #8bc34a;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            color: #181c24;
                        "
                    >
                        RANDOM
                    </button>
                </div>
                <div
                    id="crawlStatus"
                    style="text-align: center; margin-top: 10px; color: #aaa"
                ></div>
            </div>

            <div class="grid">
                <a href="/webui/index.html" class="card">
                    <h3>Chat & User Management</h3>
                    <p>
                        Return to the main interface to chat with Jeebs, manage
                        users, and train on specific URLs.
                    </p>
                </a>
                <a href="/webui/search.html" class="card">
                    <h3>Brain Search</h3>
                    <p>
                        Search through the knowledge graph nodes to see what
                        Jeebs has learned.
                    </p>
                </a>
                <a href="/webui/visualize.html" class="card">
                    <h3>Brain Visualization</h3>
                    <p>
                        View the interactive knowledge graph network to
                        understand connections between data.
                    </p>
                </a>
                <a href="/webui/logic_visualize.html" class="card">
                    <h3>Logic Graph</h3>
                    <p>
                        Visualize the logical facts and reasoning connections
                        Jeebs has learned.
                    </p>
                </a>
                <a href="/webui/logs.html" class="card">
                    <h3>Advanced Logs</h3>
                    <p>
                        Open the full log viewer with filters, export, and
                        stream controls.
                    </p>
                </a>
                <a href="/webui/evolution.html" class="card">
                    <h3>Evolution Proposals</h3>
                    <p>
                        Review, comment, and apply/deny proposed self-updates.
                    </p>
                </a>
                <a href="/webui/admin_blacklist.html" class="card">
                    <h3>IP Blacklist</h3>
                    <p>
                        Manage blocked IP addresses to prevent abuse from
                        specific sources.
                    </p>
                </a>
                <a href="/webui/admin_whitelist.html" class="card">
                    <h3>IP Whitelist</h3>
                    <p>
                        Manage whitelisted IP addresses that are allowed to
                        bypass rate limits.
                    </p>
                </a>
                <a href="/api/admin/export" class="card" target="_blank">
                    <h3>Export Database</h3>
                    <p>
                        Download a JSON backup of the entire database (Brain &
                        Store).
                    </p>
                </a>
                <div
                    class="card"
                    onclick="document.getElementById('importFile').click()"
                    style="cursor: pointer"
                >
                    <h3>Import Database</h3>
                    <p>
                        Restore data from a JSON backup file. Click to select
                        file.
                    </p>
                    <input
                        type="file"
                        id="importFile"
                        style="display: none"
                        accept=".json"
                        onchange="importDatabase(this)"
                    />
                </div>
            </div>

            <a href="/webui/index.html" class="back-link">‚Üê Back to Home</a>
        </div>

        <script>
            const ROOT_ADMIN_USERNAME = "1090mb";
            let rootAdminAuthorized = false;
            const TOKEN_KEY = "jeebs_auth_token";
            function authHeaders(contentTypeJson = false) {
                const headers = contentTypeJson
                    ? { "Content-Type": "application/json" }
                    : {};
                const token = localStorage.getItem(TOKEN_KEY);
                if (token) headers["Authorization"] = `Bearer ${token}`;
                return headers;
            }

            async function ensureRootAdminAccess() {
                try {
                    const headers = {};
                    const token = localStorage.getItem(TOKEN_KEY);
                    if (token) {
                        headers["Authorization"] = `Bearer ${token}`;
                    }

                    const res = await fetch("/api/auth/status", {
                        credentials: "same-origin",
                        headers,
                    });
                    if (!res.ok) {
                        window.location.replace("/webui/index.html");
                        return false;
                    }

                    const auth = await res.json();
                    const allowed =
                        auth.logged_in === true &&
                        auth.is_admin === true &&
                        auth.username === ROOT_ADMIN_USERNAME;

                    if (!allowed) {
                        window.location.replace("/webui/index.html");
                        return false;
                    }

                    rootAdminAuthorized = true;
                    return true;
                } catch {
                    window.location.replace("/webui/index.html");
                    return false;
                }
            }

            async function parseErrorMessage(res, fallback) {
                try {
                    const payload = await res.json();
                    if (payload && payload.error) return payload.error;
                } catch {}
                try {
                    const text = await res.text();
                    if (text) return text;
                } catch {}
                return fallback;
            }

            function asFiniteNumber(value, fallback = 0) {
                const number = Number(value);
                return Number.isFinite(number) ? number : fallback;
            }

            async function loadStatus() {
                if (!rootAdminAuthorized) return;
                try {
                    const res = await fetch("/api/admin/status", {
                        headers: authHeaders(),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const usedMb =
                            data.used_memory_mb ??
                            asFiniteNumber(data.used_memory, 0) / 1024 / 1024;
                        const totalMb =
                            data.total_memory_mb ??
                            asFiniteNumber(data.total_memory, 0) / 1024 / 1024;
                        const availableMb =
                            data.available_memory_mb ??
                            asFiniteNumber(data.available_memory, 0) /
                                1024 /
                                1024;
                        const usedPercent =
                            data.used_percent ??
                            (totalMb > 0 ? (usedMb / totalMb) * 100 : 0);

                        document.getElementById("statusContent").innerHTML = `
                        <strong>Uptime:</strong> ${data.uptime_formatted || "unknown"} &nbsp;|&nbsp;
                        <strong>Memory:</strong> ${usedMb.toFixed(2)} MB / ${totalMb.toFixed(2)} MB (${usedPercent.toFixed(1)}%) &nbsp;|&nbsp;
                        <strong>Available:</strong> ${availableMb.toFixed(2)} MB
                    `;
                    } else {
                        const message = await parseErrorMessage(
                            res,
                            "Failed to load status.",
                        );
                        document.getElementById("statusContent").innerText =
                            `Failed to load status: ${message}`;
                    }
                } catch {
                    document.getElementById("statusContent").innerText =
                        "Error loading status.";
                }
            }

            async function loadLogs() {
                if (!rootAdminAuthorized) return;
                try {
                    const res = await fetch("/api/admin/logs", {
                        headers: authHeaders(),
                    });
                    if (res.ok) {
                        const logs = await res.json();
                        const container =
                            document.getElementById("logsContent");
                        const ordered = logs.slice().reverse();
                        container.innerHTML = ordered
                            .map((l) => {
                                if (typeof l === "string") {
                                    return `<div>${l}</div>`;
                                }
                                const ts = l.timestamp || "";
                                const cat = l.category || "LOG";
                                const lvl = l.level || "INFO";
                                const msg = l.message || JSON.stringify(l);
                                return `<div>[${ts}] ${cat}/${lvl}: ${msg}</div>`;
                            })
                            .join("");
                        container.scrollTop = container.scrollHeight;
                    } else {
                        const message = await parseErrorMessage(
                            res,
                            "Failed to load logs.",
                        );
                        document.getElementById("logsContent").innerText =
                            message;
                    }
                } catch {
                    document.getElementById("logsContent").innerText =
                        "Error loading logs.";
                }
            }

            async function loadSessions() {
                if (!rootAdminAuthorized) return;
                try {
                    const res = await fetch("/api/admin/sessions", {
                        headers: authHeaders(),
                    });
                    if (res.ok) {
                        const sessions = await res.json();
                        const container =
                            document.getElementById("sessionsContent");
                        container.innerHTML = sessions.length
                            ? sessions
                                  .map(
                                      (s) => `
                        <div style="padding: 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                            <span><b>${s.username}</b> (${s.ip})</span>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span>${new Date(s.last_seen).toLocaleTimeString()}</span>
                                <button onclick="terminateSession('${s.username}')" style="padding:4px 8px; background:#d9534f; border:none; border-radius:4px; color:white; cursor:pointer;">Terminate</button>
                            </div>
                        </div>
                    `,
                                  )
                                  .join("")
                            : "No active sessions.";
                    } else {
                        const message = await parseErrorMessage(
                            res,
                            "Failed to load sessions.",
                        );
                        document.getElementById("sessionsContent").innerText =
                            message;
                    }
                } catch {
                    document.getElementById("sessionsContent").innerText =
                        "Error loading sessions.";
                }
            }

            async function loadTrainerList() {
                if (!rootAdminAuthorized) return;
                try {
                    const res = await fetch("/api/admin/users", {
                        headers: authHeaders(),
                    });
                    if (!res.ok) {
                        document.getElementById("trainerList").innerText =
                            "Unable to load trainer list.";
                        return;
                    }
                    const users = await res.json();
                    const trainers = users.filter((u) => u.role === "trainer");
                    const list = trainers.length
                        ? trainers.map((u) => `${u.username}`).join(", ")
                        : "No trainers assigned.";
                    document.getElementById("trainerList").innerText =
                        `Trainers: ${list}`;
                } catch {
                    document.getElementById("trainerList").innerText =
                        "Error loading trainer list.";
                }
            }

            async function setTrainerRole(role) {
                if (!rootAdminAuthorized) return;
                const username = document
                    .getElementById("trainerUsername")
                    .value.trim();
                const statusEl = document.getElementById("trainerRoleStatus");
                if (!username) {
                    statusEl.innerText = "Enter a username first.";
                    return;
                }

                statusEl.innerText = `Updating ${username}...`;
                try {
                    const res = await fetch("/api/admin/user/role", {
                        method: "POST",
                        headers: authHeaders(true),
                        body: JSON.stringify({ username, role }),
                    });
                    if (!res.ok) {
                        const message = await parseErrorMessage(
                            res,
                            "Failed to update role",
                        );
                        statusEl.innerText = message;
                        return;
                    }
                    statusEl.innerText = `Role updated: ${username} ‚Üí ${role}`;
                    await loadTrainerList();
                } catch (err) {
                    statusEl.innerText = `Error: ${err}`;
                }
            }

            async function terminateSession(username) {
                if (!rootAdminAuthorized) return;
                if (!confirm("Terminate session for " + username + "?")) return;
                const res = await fetch("/api/admin/session/" + username, {
                    headers: authHeaders(),
                    method: "DELETE",
                });
                if (res.ok) {
                    loadSessions();
                } else {
                    const message = await parseErrorMessage(
                        res,
                        "Failed to terminate session",
                    );
                    alert(message);
                }
            }

            async function importDatabase(input) {
                if (!rootAdminAuthorized) return;
                if (!input.files || !input.files[0]) return;
                const file = input.files[0];
                if (
                    !confirm(
                        `Are you sure you want to import ${file.name}? This will overwrite existing data.`,
                    )
                ) {
                    input.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        const res = await fetch("/api/admin/import", {
                            headers: authHeaders(true),
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(json),
                        });
                        if (res.ok) {
                            alert("Database imported successfully!");
                        } else {
                            const message = await parseErrorMessage(
                                res,
                                "Unknown error",
                            );
                            alert("Import failed: " + message);
                        }
                    } catch (err) {
                        alert("Invalid JSON file or upload error: " + err);
                    }
                    input.value = "";
                };
                reader.readAsText(file);
            }

            async function startCrawl() {
                if (!rootAdminAuthorized) return;
                const statusEl = document.getElementById("crawlStatus");
                const url = document.getElementById("crawlUrl").value.trim();
                const depthRaw = parseInt(
                    document.getElementById("crawlDepth").value,
                    10,
                );
                const depth = Number.isFinite(depthRaw)
                    ? Math.min(3, Math.max(1, depthRaw))
                    : 1;

                if (!url) {
                    statusEl.innerText = "Enter a URL to crawl.";
                    return;
                }

                statusEl.innerText = "Crawling and learning...";

                try {
                    const res = await fetch("/api/admin/crawl", {
                        method: "POST",
                        headers: authHeaders(true),
                        body: JSON.stringify({ url, depth }),
                    });

                    const text = await res.text();
                    let data = {};
                    if (text) {
                        try {
                            data = JSON.parse(text);
                        } catch {
                            data = { error: text };
                        }
                    }

                    if (!res.ok) {
                        const err =
                            data.error || data.message || `HTTP ${res.status}`;
                        statusEl.innerText = `Error: ${err}`;
                        return;
                    }

                    const visited = data.pages_visited ?? 0;
                    const stored = data.pages_stored ?? 0;
                    const links = data.links_followed ?? 0;
                    statusEl.innerText =
                        data.message ||
                        `Crawl complete. Visited ${visited} page(s), stored ${stored} node(s), discovered ${links} link(s).`;

                    if (data.ok) {
                        document.getElementById("crawlUrl").value = "";
                    }
                } catch (error) {
                    statusEl.innerText = `Crawler request failed: ${error}`;
                }
            }

            async function startRandomCrawl() {
                if (!rootAdminAuthorized) return;
                const statusEl = document.getElementById("crawlStatus");
                const depthRaw = parseInt(
                    document.getElementById("crawlDepth").value,
                    10,
                );
                const depth = Number.isFinite(depthRaw)
                    ? Math.min(3, Math.max(1, depthRaw))
                    : 1;

                statusEl.innerText = "Picking a random website and crawling...";

                try {
                    const res = await fetch(
                        `/api/admin/crawl/random?depth=${depth}`,
                        {
                            method: "POST",
                            headers: authHeaders(),
                        },
                    );

                    const text = await res.text();
                    let data = {};
                    if (text) {
                        try {
                            data = JSON.parse(text);
                        } catch {
                            data = { error: text };
                        }
                    }

                    if (!res.ok) {
                        const err =
                            data.error || data.message || `HTTP ${res.status}`;
                        statusEl.innerText = `Random crawl error: ${err}`;
                        return;
                    }

                    const visited = data.pages_visited ?? 0;
                    const stored = data.pages_stored ?? 0;
                    const links = data.links_followed ?? 0;
                    const selected = data.selected_url || "random source";
                    statusEl.innerText =
                        data.message ||
                        `Random crawl complete from ${selected}. Visited ${visited} page(s), stored ${stored} node(s), discovered ${links} link(s).`;
                } catch (error) {
                    statusEl.innerText = `Random crawler request failed: ${error}`;
                }
            }

            async function learnTopic() {
                if (!rootAdminAuthorized) return;
                const statusEl = document.getElementById("topicStatus");
                const topic = document
                    .getElementById("topicInput")
                    .value.trim();

                if (!topic) {
                    statusEl.innerText = "Please enter a topic to learn.";
                    statusEl.style.color = "#ff6b6b";
                    return;
                }

                statusEl.innerText = `üß† Learning about "${topic}"... This may take a moment.`;
                statusEl.style.color = "#ffa500";

                try {
                    // Use the chat API to ask Jeebs to learn about the topic
                    const res = await fetch("/api/jeebs", {
                        method: "POST",
                        headers: authHeaders(true),
                        body: JSON.stringify({
                            prompt: `Please research and learn everything you can about ${topic}. Search the web and store the knowledge in your brain.`,
                        }),
                    });

                    if (!res.ok) {
                        // Try to get detailed error message
                        let errorMsg = "Failed to initiate learning";
                        try {
                            const errorData = await res.json();
                            errorMsg =
                                errorData.error ||
                                errorData.message ||
                                errorMsg;
                        } catch {
                            // If JSON parsing fails, try text
                            try {
                                errorMsg = (await res.text()) || errorMsg;
                            } catch {}
                        }
                        statusEl.innerText = `‚ùå Error (${res.status}): ${errorMsg}`;
                        statusEl.style.color = "#ff6b6b";
                        return;
                    }

                    const data = await res.json();

                    if (data.response) {
                        statusEl.innerText = `‚úÖ Learning initiated! Jeebs is researching "${topic}".`;
                        statusEl.style.color = "#8bc34a";

                        // Clear the input after successful submission
                        document.getElementById("topicInput").value = "";

                        // Show Jeebs' response in a more visible way
                        setTimeout(() => {
                            statusEl.innerHTML = `‚úÖ Completed!<br><small style="color: #aaa; display: block; margin-top: 8px; max-width: 600px; margin-left: auto; margin-right: auto; text-align: left;">${data.response.substring(0, 200)}${data.response.length > 200 ? "..." : ""}</small>`;
                        }, 1000);
                    } else {
                        statusEl.innerText = `‚ö†Ô∏è Request sent but no response received`;
                        statusEl.style.color = "#ffa500";
                    }
                } catch (error) {
                    statusEl.innerText = `‚ùå Request failed: ${error.message}`;
                    statusEl.style.color = "#ff6b6b";
                }
            }

            async function loadInternetStatus() {
                if (!rootAdminAuthorized) return;
                try {
                    const res = await fetch("/api/admin/internet/status", {
                        headers: authHeaders(),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const statusEl =
                            document.getElementById("internetStatus");
                        const toggleBox =
                            document.getElementById("internetToggle");

                        if (data.enabled) {
                            statusEl.innerHTML =
                                'üü¢ <span style="color: #8bc34a;">ENABLED</span>';
                            statusEl.style.color = "#8bc34a";
                            toggleBox.style.borderColor = "#8bc34a";
                            document.querySelector(
                                "#internetToggle h3",
                            ).style.color = "#8bc34a";
                        } else {
                            statusEl.innerHTML =
                                'üî¥ <span style="color: #ff6b6b;">DISABLED</span>';
                            statusEl.style.color = "#ff6b6b";
                            toggleBox.style.borderColor = "#ff6b6b";
                            document.querySelector(
                                "#internetToggle h3",
                            ).style.color = "#ff6b6b";
                        }
                    } else {
                        document.getElementById("internetStatus").innerText =
                            "Error loading status";
                    }
                } catch {
                    document.getElementById("internetStatus").innerText =
                        "Error";
                }
            }

            async function toggleInternet() {
                if (!rootAdminAuthorized) return;

                // Get current status
                const statusRes = await fetch("/api/admin/internet/status", {
                    headers: authHeaders(),
                });

                if (!statusRes.ok) {
                    alert("Failed to get current internet status");
                    return;
                }

                const currentStatus = await statusRes.json();
                const newEnabled = !currentStatus.enabled;

                // Confirm with user
                const action = newEnabled ? "ENABLE" : "DISABLE";
                if (
                    !confirm(
                        `Are you sure you want to ${action} internet access?\n\n${newEnabled ? "This allows Jeebs to crawl websites and learn from the internet." : "This will prevent training mode from working."}`,
                    )
                ) {
                    return;
                }

                // Toggle internet
                const res = await fetch("/api/admin/internet/set", {
                    method: "POST",
                    headers: authHeaders(true),
                    body: JSON.stringify({ enabled: newEnabled }),
                });

                if (res.ok) {
                    const data = await res.json();
                    loadInternetStatus();
                    alert(
                        data.message ||
                            `Internet ${newEnabled ? "enabled" : "disabled"} successfully!`,
                    );
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    alert(
                        `Failed to toggle internet: ${errorData.error || "Unknown error"}`,
                    );
                }
            }

            async function loadTrainingStatus() {
                if (!rootAdminAuthorized) return;
                try {
                    const res = await fetch("/api/admin/training/status", {
                        headers: authHeaders(),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const statusEl =
                            document.getElementById("trainingStatus");
                        const toggleBox =
                            document.getElementById("trainingModeToggle");

                        if (data.training && data.training.enabled) {
                            statusEl.innerHTML =
                                'üü¢ <span style="color: #8bc34a;">RUNNING</span>';
                            statusEl.style.color = "#8bc34a";
                            toggleBox.style.borderColor = "#8bc34a";
                            document.querySelector(
                                "#trainingModeToggle h3",
                            ).style.color = "#8bc34a";
                        } else {
                            statusEl.innerHTML =
                                'üî¥ <span style="color: #ff6b6b;">STOPPED</span>';
                            statusEl.style.color = "#ff6b6b";
                            toggleBox.style.borderColor = "#ff6b6b";
                            document.querySelector(
                                "#trainingModeToggle h3",
                            ).style.color = "#ff6b6b";
                        }
                    } else {
                        document.getElementById("trainingStatus").innerText =
                            "Error loading status";
                    }
                } catch {
                    document.getElementById("trainingStatus").innerText =
                        "Error";
                }
            }

            async function toggleTrainingMode() {
                if (!rootAdminAuthorized) return;

                // Get current status
                const statusRes = await fetch("/api/admin/training/status", {
                    headers: authHeaders(),
                });

                if (!statusRes.ok) {
                    alert("Failed to get current training status");
                    return;
                }

                const currentStatus = await statusRes.json();
                const newEnabled = !(
                    currentStatus.training && currentStatus.training.enabled
                );

                // Confirm with user
                const action = newEnabled ? "START" : "STOP";
                if (!action === "STOP") {
                    if (
                        !confirm(
                            `Are you sure you want to ${action} training mode?\n\n${newEnabled ? "Training will automatically research topics and learn from web sources." : "This will pause automatic learning."}`,
                        )
                    ) {
                        return;
                    }
                } else if (
                    !confirm(
                        `Are you sure you want to ${action} training mode?\n\n${newEnabled ? "Training will automatically research topics and learn from web sources." : "This will pause automatic learning."}`,
                    )
                ) {
                    return;
                }

                // Toggle training mode
                const res = await fetch("/api/admin/training/mode", {
                    method: "POST",
                    headers: authHeaders(true),
                    body: JSON.stringify({ enabled: newEnabled }),
                });

                if (res.ok) {
                    const data = await res.json();
                    loadTrainingStatus();
                    alert(
                        data.message ||
                            `Training mode ${newEnabled ? "started" : "stopped"} successfully!`,
                    );
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    alert(
                        `Failed to toggle training: ${errorData.error || "Unknown error"}`,
                    );
                }
            }

            async function bootstrapDashboard() {
                const allowed = await ensureRootAdminAccess();
                if (!allowed) return;

                loadStatus();
                loadLogs();
                loadSessions();
                loadInternetStatus();
                loadTrainingStatus();
                loadTrainerList();

                setInterval(() => {
                    loadStatus();
                    loadLogs();
                    loadSessions();
                    loadInternetStatus();
                    loadTrainingStatus();
                    loadTrainerList();
                }, 5000);
            }

            bootstrapDashboard();
        </script>
    </body>
</html>
