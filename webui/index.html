<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>JeebsAI Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="padding-top:60px">
    <h1 style="margin-bottom:24px">JeebsAI Console</h1>
    <div class="card card-glow" style="margin-bottom:24px;text-align:center">
        <h2 style="margin-bottom:8px">Welcome to JeebsAI</h2>
        <p class="text-muted">Use the navigation above or quick actions below.</p>
    </div>
    <div class="card" style="margin-bottom:24px">
        <h3>Quick Actions</h3>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
            <a href="/webui/search.html" class="btn btn-accent">Brain Search</a>
            <a href="/webui/trainer_panel.html" class="btn btn-primary" id="trainerQuick" style="display:none">Trainer Panel</a>
            <a href="/webui/admin_dashboard.html" class="btn btn-ghost" id="adminQuick" style="display:none">Admin Dashboard</a>
        </div>
    </div>
    <div class="card">
        <h3>Recent Activity</h3>
        <div id="activityLog" class="log-box" style="min-height:120px;max-height:320px">Loading...</div>
    </div>
</div>
<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
// Show/hide quick actions based on role
async function updateQuickActions() {
    const auth = await getAuthState();
    document.getElementById('adminQuick').style.display = (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN) ? '' : 'none';
    document.getElementById('trainerQuick').style.display = (auth.isTrainer || (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN)) ? '' : 'none';
}
updateQuickActions();
JeebsNav.init('home');
</script>
</body>
</html>
                width: min(980px, 100%);
                display: grid;
                gap: 16px;
            }

            .panel {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 18px;
                box-shadow: 0 20px 50px rgba(2, 8, 13, 0.35);
                backdrop-filter: blur(8px);
            }

            .topbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 18px 20px;
                gap: 12px;
            }

            .brand h1 {
                margin: 0;
                font-size: clamp(1.3rem, 1.8vw, 1.7rem);
                letter-spacing: 0.02em;
            }

            .brand p {
                margin: 4px 0 0;
                color: var(--muted);
                font-size: 0.92rem;
            }

            .status-chip {
                border: 1px solid var(--line);
                border-radius: 999px;
                padding: 8px 12px;
                font-size: 0.84rem;
                color: var(--muted);
                white-space: nowrap;
            }

            .auth {
                padding: 18px 20px 20px;
            }

            .tabs {
                display: flex;
                gap: 8px;
                margin-bottom: 16px;
            }

            .tabs button {
                border: 1px solid var(--line);
                background: rgba(11, 29, 40, 0.8);
                color: var(--muted);
                border-radius: 999px;
                padding: 8px 13px;
                font-weight: 600;
                cursor: pointer;
                transition: 160ms ease;
            }

            .tabs button.active {
                color: #03101a;
                background: var(--accent);
                border-color: transparent;
            }

            .view {
                display: none;
            }

            .view.active {
                display: block;
            }

            .grid-2 {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            label {
                display: block;
                font-size: 0.86rem;
                color: var(--muted);
                margin-bottom: 6px;
            }

            input,
            textarea {
                width: 100%;
                border: 1px solid var(--line);
                background: var(--card-strong);
                color: var(--text);
                border-radius: 12px;
                padding: 10px 12px;
                font: inherit;
            }

            textarea {
                resize: vertical;
                min-height: 96px;
            }

            input:focus,
            textarea:focus {
                outline: 2px solid rgba(83, 216, 251, 0.4);
                border-color: rgba(83, 216, 251, 0.8);
            }

            .row {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            button.primary,
            button.secondary,
            button.ghost {
                border: 0;
                border-radius: 12px;
                padding: 10px 14px;
                font: inherit;
                font-weight: 600;
                cursor: pointer;
            }

            button.primary {
                background: linear-gradient(135deg, #53d8fb, #39b7e0);
                color: #03202f;
            }

            button.secondary {
                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                color: #201406;
            }

            button.ghost {
                background: rgba(83, 216, 251, 0.12);
                color: var(--accent);
                border: 1px solid rgba(83, 216, 251, 0.35);
            }

            .ghost-link {
                display: inline-flex;
                align-items: center;
                border-radius: 12px;
                padding: 10px 14px;
                font: inherit;
                font-weight: 600;
                text-decoration: none;
                background: rgba(83, 216, 251, 0.12);
                color: var(--accent);
                border: 1px solid rgba(83, 216, 251, 0.35);
            }

            .muted {
                color: var(--muted);
                font-size: 0.86rem;
                margin-top: 10px;
            }

            .chat {
                padding: 18px 20px 20px;
                display: none;
            }

            .chat.show {
                display: block;
            }

            .chat-header {
                display: flex;
                justify-content: space-between;
                gap: 10px;
                align-items: center;
                margin-bottom: 14px;
                flex-wrap: wrap;
            }

            .chat-meta {
                color: var(--muted);
                font-size: 0.9rem;
            }

            .token-box {
                border: 1px dashed rgba(83, 216, 251, 0.45);
                border-radius: 12px;
                padding: 10px 12px;
                font-family: "JetBrains Mono", monospace;
                font-size: 0.8rem;
                color: #b5f0ff;
                background: rgba(8, 24, 34, 0.75);
                max-width: 100%;
                overflow-wrap: anywhere;
            }

            .feed {
                border: 1px solid var(--line);
                border-radius: 14px;
                background: rgba(8, 22, 31, 0.72);
                height: min(52vh, 420px);
                overflow-y: auto;
                padding: 12px;
                margin-bottom: 12px;
                display: grid;
                gap: 10px;
            }

            .bubble {
                border-radius: 12px;
                padding: 10px 12px;
                line-height: 1.45;
            }

            .bubble.user {
                background: rgba(83, 216, 251, 0.14);
                border: 1px solid rgba(83, 216, 251, 0.35);
            }

            .bubble.jeebs {
                background: rgba(251, 191, 36, 0.12);
                border: 1px solid rgba(251, 191, 36, 0.3);
            }

            .bubble small {
                display: block;
                margin-bottom: 4px;
                color: var(--muted);
                font-size: 0.76rem;
                letter-spacing: 0.03em;
                text-transform: uppercase;
            }

            .prompt-form {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 8px;
            }

            .status-bar {
                min-height: 24px;
                font-size: 0.9rem;
                color: var(--muted);
                padding: 0 4px;
            }

            .status-bar.good {
                color: var(--good);
            }

            .status-bar.bad {
                color: var(--bad);
            }

            @media (max-width: 760px) {
                .grid-2 {
                    grid-template-columns: 1fr;
                }

                .prompt-form {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <nav id="topnav"></nav>
        <div class="shell" style="padding-top:60px;max-width:900px">
            <div class="card card-glow" style="margin-bottom:24px;text-align:center">
                <h1 style="margin-bottom:8px">JeebsAI Console</h1>
                <p class="text-muted">Welcome to JeebsAI. Use the navigation above or quick actions below.</p>
            </div>
            <div class="card" style="margin-bottom:24px">
                <h3>Quick Actions</h3>
                <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
                    <a href="/webui/search.html" class="btn btn-accent">Brain Search</a>
                    <a href="/webui/trainer_panel.html" class="btn btn-primary" id="trainerQuick" style="display:none">Trainer Panel</a>
                    <a href="/webui/admin_dashboard.html" class="btn btn-ghost" id="adminQuick" style="display:none">Admin Dashboard</a>
                </div>
            </div>
            <div class="card">
                <h3>Recent Activity</h3>
                <div id="activityLog" class="log-box" style="min-height:120px;max-height:320px">Loading...</div>
            </div>
        </div>

                <div id="registerView" class="view">
                    <form id="registerForm">
                        <div class="grid-2">
                            <div>
                                <label for="regUsername">Username</label>
                                <input
                                    id="regUsername"
                                    name="username"
                                    required
                                />
                            </div>
                            <div>
                                <label for="regEmail">Email (optional)</label>
                                <input
                                    id="regEmail"
                                    name="email"
                                    type="email"
                                />
                            </div>
                        </div>

                        <label for="publicKey"
                            >PGP public key (ASCII armored)</label
                        >
                        <textarea
                            id="publicKey"
                            name="pgp_public_key"
                            required
                        ></textarea>

                        <div class="row">
                            <button type="submit" class="secondary">
                                Create PGP Account
                            </button>
                        </div>
                    </form>
                    <p class="muted">
                        Registration stores your public key. Login verifies your
                        signature against this key.
                    </p>
                </div>
            </section>

            <section class="panel chat" id="chatPanel">
                <div class="chat-header">
                    <div class="chat-meta" id="chatMeta"></div>
                    <div class="row">
                        <a
                            id="adminControlsLink"
                            class="ghost-link"
                            href="/webui/admin_dashboard.html"
                            style="display: none"
                        >
                            Admin Controls
                        </a>
                        <a
                            id="trainerPanelLink"
                            class="ghost-link"
                            href="/webui/trainer_panel.html"
                            style="display: none"
                        >
                            Trainer Panel
                        </a>
                        <button id="copyTokenBtn" class="ghost" type="button">
                            Copy Token
                        </button>
                        <button id="logoutBtn" class="ghost" type="button">
                            Logout
                        </button>
                    </div>
                </div>
                <div class="token-box" id="tokenBox"></div>

                <div class="feed" id="chatFeed"></div>

                <form id="chatForm" class="prompt-form">
                    <input
                        id="promptInput"
                        autocomplete="off"
                        placeholder="Talk to JeebsAI..."
                        required
                    />
                    <button class="primary" type="submit">Send</button>
                </form>
            </section>

            <div id="statusBar" class="status-bar"></div>
        </main>

        <script src="/webui/auth.js"></script>
        <script src="/webui/nav.js"></script>
        <script>
            // Show/hide quick actions based on role
            async function updateQuickActions() {
                const auth = await getAuthState();
                document.getElementById('adminQuick').style.display = (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN) ? '' : 'none';
                document.getElementById('trainerQuick').style.display = (auth.isTrainer || (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN)) ? '' : 'none';
            }
            updateQuickActions();
            JeebsNav.init('home');

            function setStatus(message, level = "info") {
                statusBar.textContent = message || "";
                statusBar.className = "status-bar";
                if (level === "good") statusBar.classList.add("good");
                if (level === "bad") statusBar.classList.add("bad");
            }

            function setView(view) {
                document.querySelectorAll(".tabs button").forEach((button) => {
                    button.classList.toggle(
                        "active",
                        button.dataset.view === view,
                    );
                });
                document.querySelectorAll(".view").forEach((node) => {
                    node.classList.toggle("active", node.id === `${view}View`);
                });
            }

            function updateUnsignedMessage() {
                const username = document
                    .getElementById("loginUsername")
                    .value.trim();
                const ts = Math.floor(Date.now() / 1000);
                const value = `LOGIN:${username || "username"}:${ts}`;
                document.getElementById("unsignedMessage").value = value;
            }

            function appendMessage(who, text) {
                const bubble = document.createElement("div");
                bubble.className = `bubble ${who}`;
                const label = document.createElement("small");
                label.textContent = who === "user" ? "You" : "JeebsAI";
                const body = document.createElement("div");
                body.textContent = text;
                bubble.append(label, body);
                chatFeed.appendChild(bubble);
                chatFeed.scrollTop = chatFeed.scrollHeight;
            }

            function renderAuthState() {
                if (!state.loggedIn) {
                    authPanel.style.display = "block";
                    chatPanel.classList.remove("show");
                    statusChip.textContent = "Not logged in";
                    adminControlsLink.style.display = "none";
                    trainerPanelLink.style.display = "none";
                    stopSessionPing();
                    return;
                }

                authPanel.style.display = "none";
                chatPanel.classList.add("show");
                statusChip.textContent = `Logged in as ${state.username}`;
                chatMeta.textContent = `${state.username}${state.isAdmin ? " (admin)" : ""}`;
                tokenBox.textContent = state.token
                    ? `Token: ${state.token}`
                    : "Token missing from session response.";
                adminControlsLink.style.display = isRootAdminSession()
                    ? "inline-flex"
                    : "none";
                trainerPanelLink.style.display = canAccessTrainerPanel()
                    ? "inline-flex"
                    : "none";
                promptInput.focus();
                startSessionPing();
            }

            /* Session ping via auth.js startSessionPing / stopSessionPing */

            async function requestJson(url, options = {}) {
                const headers = new Headers(options.headers || {});
                if (options.body && !headers.has("Content-Type")) {
                    headers.set("Content-Type", "application/json");
                }
                if (state.token && !headers.has("Authorization")) {
                    headers.set("Authorization", `Bearer ${state.token}`);
                }

                const response = await safeFetch(url, {
                    ...options,
                    headers,
                    credentials: "same-origin",
                });

                let payload = {};
                try {
                    payload = await response.json();
                } catch {
                    payload = {};
                }

                if (!response.ok) {
                    throw new Error(
                        payload.error || `Request failed (${response.status})`,
                    );
                }

                return payload;
            }

            async function bootstrapAuth() {
                try {
                    const data = await requestJson("/api/auth/status");
                    state.loggedIn = Boolean(data.logged_in);
                    state.username = data.username || "";
                    state.isAdmin = Boolean(data.is_admin);
                    state.isTrainer = Boolean(data.is_trainer);
                    if (data.token) {
                        state.token = data.token;
                        jeebsSetToken(state.token);
                    }
                    renderAuthState();
                    if (state.loggedIn) {
                        appendMessage(
                            "jeebs",
                            "You are authenticated. Ask me anything.",
                        );
                    }
                } catch (error) {
                    state.loggedIn = false;
                    renderAuthState();
                    setStatus(error.message, "bad");
                }
            }

            document.querySelectorAll(".tabs button").forEach((button) => {
                button.addEventListener("click", () =>
                    setView(button.dataset.view),
                );
            });

            document
                .getElementById("loginUsername")
                .addEventListener("input", updateUnsignedMessage);
            document
                .getElementById("generateChallengeBtn")
                .addEventListener("click", () => {
                    updateUnsignedMessage();
                    setStatus("Challenge refreshed.", "good");
                });
            document
                .getElementById("copyChallengeBtn")
                .addEventListener("click", async () => {
                    try {
                        await navigator.clipboard.writeText(
                            document.getElementById("unsignedMessage").value,
                        );
                        setStatus("Challenge copied.", "good");
                    } catch {
                        setStatus(
                            "Clipboard access failed. Copy manually.",
                            "bad",
                        );
                    }
                });

            document
                .getElementById("registerForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const username = document
                        .getElementById("regUsername")
                        .value.trim();
                    const email = document
                        .getElementById("regEmail")
                        .value.trim();
                    const pgpPublicKey = document
                        .getElementById("publicKey")
                        .value.trim();

                    try {
                        await requestJson("/api/register", {
                            method: "POST",
                            body: JSON.stringify({
                                username,
                                email,
                                pgp_public_key: pgpPublicKey,
                            }),
                        });

                        document.getElementById("loginUsername").value =
                            username;
                        updateUnsignedMessage();
                        setView("login");
                        setStatus(
                            "Registration complete. Sign the challenge and log in.",
                            "good",
                        );
                    } catch (error) {
                        setStatus(
                            `Registration failed: ${error.message}`,
                            "bad",
                        );
                    }
                });

            document
                .getElementById("loginForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();

                    const username = document
                        .getElementById("loginUsername")
                        .value.trim();
                    const signedMessage = document
                        .getElementById("signedMessage")
                        .value.trim();
                    const rememberMe =
                        document.getElementById("rememberMe").checked;

                    try {
                        const data = await requestJson("/api/login_pgp", {
                            method: "POST",
                            body: JSON.stringify({
                                username,
                                signed_message: signedMessage,
                                remember_me: rememberMe,
                            }),
                        });

                        state.loggedIn = true;
                        state.username = data.username || username;
                        state.isAdmin = Boolean(data.is_admin);
                        state.isTrainer = Boolean(data.is_trainer);
                        state.token = data.token || "";

                        if (state.token) {
                            jeebsSetToken(state.token);
                        }

                        renderAuthState();
                        appendMessage(
                            "jeebs",
                            "PGP login successful. Session token is active.",
                        );
                        setStatus("Logged in successfully.", "good");
                    } catch (error) {
                        setStatus(`Login failed: ${error.message}`, "bad");
                    }
                });

            document
                .getElementById("chatForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();
                    if (!state.loggedIn) {
                        setStatus("Log in before sending messages.", "bad");
                        return;
                    }

                    const prompt = promptInput.value.trim();
                    if (!prompt) return;

                    appendMessage("user", prompt);
                    promptInput.value = "";

                    try {
                        const data = await requestJson("/api/chat", {
                            method: "POST",
                            body: JSON.stringify({ message: prompt }),
                        });
                        appendMessage(
                            "jeebs",
                            data.response || "(No response body)",
                        );
                    } catch (error) {
                        appendMessage("jeebs", `Error: ${error.message}`);
                        setStatus(
                            `Chat request failed: ${error.message}`,
                            "bad",
                        );
                    }
                });

            document
                .getElementById("copyTokenBtn")
                .addEventListener("click", async () => {
                    if (!state.token) {
                        setStatus("No token available.", "bad");
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(state.token);
                        setStatus("Token copied.", "good");
                    } catch {
                        setStatus(
                            "Clipboard access failed. Copy manually.",
                            "bad",
                        );
                    }
                });

            document
                .getElementById("logoutBtn")
                .addEventListener("click", async () => {
                    try {
                        await requestJson("/api/logout", { method: "POST" });
                    } catch {
                        // No-op; continue local cleanup.
                    }

                    state.loggedIn = false;
                    state.username = "";
                    state.isAdmin = false;
                    state.isTrainer = false;
                    state.token = "";
                    jeebsClearToken();
                    chatFeed.innerHTML = "";
                    setView("login");
                    renderAuthState();
                    setStatus("Logged out.", "good");
                });

            updateUnsignedMessage();
            renderAuthState();
            bootstrapAuth();
        </script>
    </body>
</html>
