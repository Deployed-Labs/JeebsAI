<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>JeebsAI Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>
    <nav id="topnav"></nav>
    <div class="chat-container">
        <div class="chat-wrapper">
                <div id="authViews">
                    <div id="loginView" class="view active">
                        <div class="auth-card">
                            <h2>Welcome to JeebsAI</h2>
                            <p class="subtitle">Sign in to start chatting</p>
                            <form id="loginForm">
                                <div class="form-group">
                                    <label for="loginUsername">Username</label>
                                    <input
                                        id="loginUsername"
                                        name="username"
                                        required
                                        placeholder="Enter your username"
                                    />
                                </div>
                                <div class="form-group">
                                    <label for="signedMessage">Signed Message</label>
                                    <textarea
                                        id="signedMessage"
                                        name="signed_message"
                                        required
                                        placeholder="Paste your PGP signature here"
                                    ></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="generateChallengeBtn" class="btn-secondary">
                                        Generate Challenge
                                    </button>
                                    <button type="button" id="copyChallengeBtn" class="btn-secondary">
                                        Copy Challenge
                                    </button>
                                    <button type="submit" class="btn-primary">
                                        Sign In
                                    </button>
                                </div>
                                <div class="form-options">
                                    <input type="checkbox" id="rememberMe" />
                                    <label for="rememberMe">Remember me</label>
                                </div>
                            </form>
                            <div class="auth-links">
                                <button id="switchToRegister" class="link-btn">
                                    Need an account? Register
                                </button>
                            </div>
                            <div class="challenge-display">
                                <p id="unsignedMessage"></p>
                            </div>
                        </div>
                    </div>
                    <div id="registerView" class="view">
                        <div class="auth-card">
                            <h2>Create Account</h2>
                            <p class="subtitle">Join JeebsAI with PGP authentication</p>
                            <form id="registerForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="regUsername">Username</label>
                                        <input
                                            id="regUsername"
                                            name="username"
                                            required
                                            placeholder="Choose a username"
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="regEmail">Email (optional)</label>
                                        <input
                                            id="regEmail"
                                            name="email"
                                            type="email"
                                            placeholder="your@email.com"
                                        />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="publicKey">PGP Public Key</label>
                                    <textarea
                                        id="publicKey"
                                        name="pgp_public_key"
                                        required
                                        placeholder="Paste your ASCII-armored PGP public key"
                                    ></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">
                                        Create Account
                                    </button>
                                </div>
                            </form>
                            <div class="auth-links">
                                <button id="switchToLogin" class="link-btn">
                                    Already have an account? Sign in
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <section class="chat-panel" id="chatPanel">
                    <div class="chat-header">
                        <div class="chat-info">
                            <div class="chat-avatar">
                                <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2"/>
                                    <circle cx="16" cy="16" r="6" fill="currentColor" opacity=".6"/>
                                    <path d="M16 2v8M16 22v8M2 16h8M22 16h8" stroke="currentColor" stroke-width="1.5" opacity=".4"/>
                                </svg>
                            </div>
                            <div class="chat-details">
                                <h3>JeebsAI</h3>
                                <div class="chat-meta" id="chatMeta">AI Assistant</div>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button id="copyTokenBtn" class="action-btn" title="Copy Token">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button id="logoutBtn" class="action-btn" title="Logout">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16,17 21,12 16,7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="token-display" id="tokenBox"></div>
                    <div class="chat-messages" id="chatFeed"></div>
                    <div class="chat-input">
                        <form id="chatForm" class="message-form">
                            <div class="input-wrapper">
                                <input
                                    id="promptInput"
                                    autocomplete="off"
                                    placeholder="Type your message to JeebsAI..."
                                    required
                                />
                                <button class="send-btn" type="submit">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22,2 15,22 11,13 2,9"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </div>
    </div>

        <script src="/webui/auth.js"></script>
        <script src="/webui/nav.js"></script>
        <script>
            // Show/hide quick actions based on role
            async function updateQuickActions() {
                const auth = await getAuthState();
                document.getElementById('adminQuick').style.display = (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN) ? '' : 'none';
                document.getElementById('trainerQuick').style.display = (auth.isTrainer || (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN)) ? '' : 'none';
            }
            updateQuickActions();
            JeebsNav.init('home');

            function setView(view) {
                document.querySelectorAll("#authViews .view").forEach((node) => {
                    node.classList.toggle("active", node.id === `${view}View`);
                });
            }

            function renderAuthState() {
                if (!state.loggedIn) {
                    document.getElementById('authViews').style.display = "flex";
                    document.getElementById('chatPanel').style.display = "none";
                    statusChip.textContent = "Not logged in";
                    adminControlsLink.style.display = "none";
                    trainerPanelLink.style.display = "none";
                    document.getElementById('menuAdmin').style.display = 'none';
                    document.getElementById('menuTrainer').style.display = 'none';
                    stopSessionPing();
                    return;
                }

                document.getElementById('authViews').style.display = "none";
                document.getElementById('chatPanel').style.display = "flex";
                statusChip.textContent = `Logged in as ${state.username}`;
                chatMeta.textContent = `${state.username}${state.isAdmin ? " (admin)" : ""}`;
                tokenBox.textContent = state.token
                    ? `Token: ${state.token}`
                    : "Token missing from session response.";
                adminControlsLink.style.display = isRootAdminSession()
                    ? "inline-flex"
                    : "none";
                trainerPanelLink.style.display = canAccessTrainerPanel()
                    ? "inline-flex"
                    : "none";
                document.getElementById('menuAdmin').style.display = (state.isAdmin && state.username === JEEBS_ROOT_ADMIN) ? 'block' : 'none';
                document.getElementById('menuTrainer').style.display = (state.isTrainer || (state.isAdmin && state.username === JEEBS_ROOT_ADMIN)) ? 'block' : 'none';
                promptInput.focus();
                startSessionPing();
            }

            function setView(view) {
                document.querySelectorAll(".tabs button").forEach((button) => {
                    button.classList.toggle(
                        "active",
                        button.dataset.view === view,
                    );
                });
                document.querySelectorAll(".view").forEach((node) => {
                    node.classList.toggle("active", node.id === `${view}View`);
                });
            }

            function updateUnsignedMessage() {
                const username = document
                    .getElementById("loginUsername")
                    .value.trim();
                const ts = Math.floor(Date.now() / 1000);
                const value = `LOGIN:${username || "username"}:${ts}`;
                document.getElementById("unsignedMessage").value = value;
            }

            function appendMessage(who, text) {
                const bubble = document.createElement("div");
                bubble.className = `bubble ${who}`;
                const label = document.createElement("small");
                label.textContent = who === "user" ? "You" : "JeebsAI";
                const body = document.createElement("div");
                body.textContent = text;
                bubble.append(label, body);
                chatFeed.appendChild(bubble);
                chatFeed.scrollTop = chatFeed.scrollHeight;
            }

            function showTyping() {
                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.id = 'typingIndicator';
                indicator.innerHTML = '<span>JeebsAI is typing</span><div class="dot"></div><div class="dot"></div><div class="dot"></div>';
                chatFeed.appendChild(indicator);
                chatFeed.scrollTop = chatFeed.scrollHeight;
            }

            function hideTyping() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) indicator.remove();
            }

            function renderAuthState() {
                if (!state.loggedIn) {
                    authPanel.style.display = "block";
                    chatPanel.classList.remove("show");
                    statusChip.textContent = "Not logged in";
                    adminControlsLink.style.display = "none";
                    trainerPanelLink.style.display = "none";
                    document.getElementById('menuAdmin').style.display = 'none';
                    document.getElementById('menuTrainer').style.display = 'none';
                    stopSessionPing();
                    return;
                }

                authPanel.style.display = "none";
                chatPanel.classList.add("show");
                statusChip.textContent = `Logged in as ${state.username}`;
                chatMeta.textContent = `${state.username}${state.isAdmin ? " (admin)" : ""}`;
                tokenBox.textContent = state.token
                    ? `Token: ${state.token}`
                    : "Token missing from session response.";
                adminControlsLink.style.display = isRootAdminSession()
                    ? "inline-flex"
                    : "none";
                trainerPanelLink.style.display = canAccessTrainerPanel()
                    ? "inline-flex"
                    : "none";
                document.getElementById('menuAdmin').style.display = (state.isAdmin && state.username === JEEBS_ROOT_ADMIN) ? 'block' : 'none';
                document.getElementById('menuTrainer').style.display = (state.isTrainer || (state.isAdmin && state.username === JEEBS_ROOT_ADMIN)) ? 'block' : 'none';
                promptInput.focus();
                startSessionPing();
            }

            /* Session ping via auth.js startSessionPing / stopSessionPing */

            async function requestJson(url, options = {}) {
                const headers = new Headers(options.headers || {});
                if (options.body && !headers.has("Content-Type")) {
                    headers.set("Content-Type", "application/json");
                }
                if (state.token && !headers.has("Authorization")) {
                    headers.set("Authorization", `Bearer ${state.token}`);
                }

                const response = await safeFetch(url, {
                    ...options,
                    headers,
                    credentials: "same-origin",
                });

                let payload = {};
                try {
                    payload = await response.json();
                } catch {
                    payload = {};
                }

                if (!response.ok) {
                    throw new Error(
                        payload.error || `Request failed (${response.status})`,
                    );
                }

                return payload;
            }

            async function bootstrapAuth() {
                try {
                    const data = await requestJson("/api/auth/status");
                    state.loggedIn = Boolean(data.logged_in);
                    state.username = data.username || "";
                    state.isAdmin = Boolean(data.is_admin);
                    state.isTrainer = Boolean(data.is_trainer);
                    if (data.token) {
                        state.token = data.token;
                        jeebsSetToken(state.token);
                    }
                    renderAuthState();
                    if (state.loggedIn) {
                        appendMessage(
                            "jeebs",
                            "You are authenticated. Ask me anything.",
                        );
                    }
                } catch (error) {
                    state.loggedIn = false;
                    renderAuthState();
                    setStatus(error.message, "bad");
                }
            }

            document.querySelectorAll(".tabs button").forEach((button) => {
                button.addEventListener("click", () =>
                    setView(button.dataset.view),
                );
            });

            document.getElementById("switchToRegister").addEventListener("click", () => setView("register"));
            document.getElementById("switchToLogin").addEventListener("click", () => setView("login"));

            document
                .getElementById("loginUsername")
                .addEventListener("input", updateUnsignedMessage);
            document
                .getElementById("generateChallengeBtn")
                .addEventListener("click", () => {
                    updateUnsignedMessage();
                    setStatus("Challenge refreshed.", "good");
                });
            document
                .getElementById("copyChallengeBtn")
                .addEventListener("click", async () => {
                    try {
                        await navigator.clipboard.writeText(
                            document.getElementById("unsignedMessage").value,
                        );
                        setStatus("Challenge copied.", "good");
                    } catch {
                        setStatus(
                            "Clipboard access failed. Copy manually.",
                            "bad",
                        );
                    }
                });

            document
                .getElementById("registerForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const username = document
                        .getElementById("regUsername")
                        .value.trim();
                    const email = document
                        .getElementById("regEmail")
                        .value.trim();
                    const pgpPublicKey = document
                        .getElementById("publicKey")
                        .value.trim();

                    try {
                        await requestJson("/api/register", {
                            method: "POST",
                            body: JSON.stringify({
                                username,
                                email,
                                pgp_public_key: pgpPublicKey,
                            }),
                        });

                        document.getElementById("loginUsername").value =
                            username;
                        updateUnsignedMessage();
                        setView("login");
                        setStatus(
                            "Registration complete. Sign the challenge and log in.",
                            "good",
                        );
                    } catch (error) {
                        setStatus(
                            `Registration failed: ${error.message}`,
                            "bad",
                        );
                    }
                });

            document
                .getElementById("loginForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();

                    const username = document
                        .getElementById("loginUsername")
                        .value.trim();
                    const signedMessage = document
                        .getElementById("signedMessage")
                        .value.trim();
                    const rememberMe =
                        document.getElementById("rememberMe").checked;

                    try {
                        const data = await requestJson("/api/login_pgp", {
                            method: "POST",
                            body: JSON.stringify({
                                username,
                                signed_message: signedMessage,
                                remember_me: rememberMe,
                            }),
                        });

                        state.loggedIn = true;
                        state.username = data.username || username;
                        state.isAdmin = Boolean(data.is_admin);
                        state.isTrainer = Boolean(data.is_trainer);
                        state.token = data.token || "";

                        if (state.token) {
                            jeebsSetToken(state.token);
                        }

                        renderAuthState();
                        appendMessage(
                            "jeebs",
                            "PGP login successful. Session token is active.",
                        );
                        setStatus("Logged in successfully.", "good");
                    } catch (error) {
                        setStatus(`Login failed: ${error.message}`, "bad");
                    }
                });

            document
                .getElementById("chatForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();
                    if (!state.loggedIn) {
                        setStatus("Log in before sending messages.", "bad");
                        return;
                    }

                    const prompt = promptInput.value.trim();
                    if (!prompt) return;

                    appendMessage("user", prompt);
                    promptInput.value = "";
                    showTyping();

                    try {
                        const data = await requestJson("/api/chat", {
                            method: "POST",
                            body: JSON.stringify({ message: prompt }),
                        });
                        hideTyping();
                        appendMessage(
                            "jeebs",
                            data.response || "(No response body)",
                        );
                    } catch (error) {
                        hideTyping();
                        appendMessage("jeebs", `Error: ${error.message}`);
                        setStatus(
                            `Chat request failed: ${error.message}`,
                            "bad",
                        );
                    }
                });

            document
                .getElementById("copyTokenBtn")
                .addEventListener("click", async () => {
                    if (!state.token) {
                        setStatus("No token available.", "bad");
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(state.token);
                        setStatus("Token copied.", "good");
                    } catch {
                        setStatus(
                            "Clipboard access failed. Copy manually.",
                            "bad",
                        );
                    }
                });

            document
                .getElementById("logoutBtn")
                .addEventListener("click", async () => {
                    try {
                        await requestJson("/api/logout", { method: "POST" });
                    } catch {
                        // No-op; continue local cleanup.
                    }

                    state.loggedIn = false;
                    state.username = "";
                    state.isAdmin = false;
                    state.isTrainer = false;
                    state.token = "";
                    jeebsClearToken();
                    chatFeed.innerHTML = "";
                    setView("login");
                    renderAuthState();
                    setStatus("Logged out.", "good");
                });

            updateUnsignedMessage();
            renderAuthState();
            bootstrapAuth();
        </script>
    </body>
</html>
