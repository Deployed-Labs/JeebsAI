<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>JeebsAI Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>


        
    </head>
    <body>
        <nav id="topnav"></nav>
        <div class="shell" style="padding-top:60px;max-width:900px">
            <div class="card card-glow" style="margin-bottom:24px;text-align:center">
                <h1 style="margin-bottom:8px">JeebsAI Console</h1>
                <p class="text-muted">Welcome to JeebsAI. Use the navigation above or quick actions below.</p>
            </div>
            <div class="card" style="margin-bottom:24px">
                <h3>Quick Actions</h3>
                <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
                    <a href="/webui/search.html" class="btn btn-accent">Brain Search</a>
                    <a href="/webui/trainer_panel.html" class="btn btn-primary" id="trainerQuick" style="display:none">Trainer Panel</a>
                    <a href="/webui/admin_dashboard.html" class="btn btn-ghost" id="adminQuick" style="display:none">Admin Dashboard</a>
                </div>
            </div>
            <div class="card">
                <h3>Recent Activity</h3>
                <div id="activityLog" class="log-box" style="min-height:120px;max-height:320px">Loading...</div>
            </div>
        </div>

                <div id="registerView" class="view">
                    <form id="registerForm">
                        <div class="grid-2">
                            <div>
                                <label for="regUsername">Username</label>
                                <input
                                    id="regUsername"
                                    name="username"
                                    required
                                />
                            </div>
                            <div>
                                <label for="regEmail">Email (optional)</label>
                                <input
                                    id="regEmail"
                                    name="email"
                                    type="email"
                                />
                            </div>
                        </div>

                        <label for="publicKey"
                            >PGP public key (ASCII armored)</label
                        >
                        <textarea
                            id="publicKey"
                            name="pgp_public_key"
                            required
                        ></textarea>

                        <div class="row">
                            <button type="submit" class="secondary">
                                Create PGP Account
                            </button>
                        </div>
                    </form>
                    <p class="muted">
                        Registration stores your public key. Login verifies your
                        signature against this key.
                    </p>
                </div>
            </section>

            <section class="panel chat" id="chatPanel">
                <div class="chat-header">
                    <div class="chat-meta" id="chatMeta"></div>
                    <div class="row">
                        <a
                            id="adminControlsLink"
                            class="ghost-link"
                            href="/webui/admin_dashboard.html"
                            style="display: none"
                        >
                            Admin Controls
                        </a>
                        <a
                            id="trainerPanelLink"
                            class="ghost-link"
                            href="/webui/trainer_panel.html"
                            style="display: none"
                        >
                            Trainer Panel
                        </a>
                        <button id="copyTokenBtn" class="ghost" type="button">
                            Copy Token
                        </button>
                        <button id="logoutBtn" class="ghost" type="button">
                            Logout
                        </button>
                    </div>
                </div>
                <div class="token-box" id="tokenBox"></div>

                <div class="feed" id="chatFeed"></div>

                <form id="chatForm" class="prompt-form">
                    <input
                        id="promptInput"
                        autocomplete="off"
                        placeholder="Talk to JeebsAI..."
                        required
                    />
                    <button class="primary" type="submit">Send</button>
                </form>
            </section>

            <div id="statusBar" class="status-bar"></div>
        </main>

        <script src="/webui/auth.js"></script>
        <script src="/webui/nav.js"></script>
        <script>
            // Show/hide quick actions based on role
            async function updateQuickActions() {
                const auth = await getAuthState();
                document.getElementById('adminQuick').style.display = (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN) ? '' : 'none';
                document.getElementById('trainerQuick').style.display = (auth.isTrainer || (auth.isAdmin && auth.username === JEEBS_ROOT_ADMIN)) ? '' : 'none';
            }
            updateQuickActions();
            JeebsNav.init('home');

            function setStatus(message, level = "info") {
                statusBar.textContent = message || "";
                statusBar.className = "status-bar";
                if (level === "good") statusBar.classList.add("good");
                if (level === "bad") statusBar.classList.add("bad");
            }

            function setView(view) {
                document.querySelectorAll(".tabs button").forEach((button) => {
                    button.classList.toggle(
                        "active",
                        button.dataset.view === view,
                    );
                });
                document.querySelectorAll(".view").forEach((node) => {
                    node.classList.toggle("active", node.id === `${view}View`);
                });
            }

            function updateUnsignedMessage() {
                const username = document
                    .getElementById("loginUsername")
                    .value.trim();
                const ts = Math.floor(Date.now() / 1000);
                const value = `LOGIN:${username || "username"}:${ts}`;
                document.getElementById("unsignedMessage").value = value;
            }

            function appendMessage(who, text) {
                const bubble = document.createElement("div");
                bubble.className = `bubble ${who}`;
                const label = document.createElement("small");
                label.textContent = who === "user" ? "You" : "JeebsAI";
                const body = document.createElement("div");
                body.textContent = text;
                bubble.append(label, body);
                chatFeed.appendChild(bubble);
                chatFeed.scrollTop = chatFeed.scrollHeight;
            }

            function renderAuthState() {
                if (!state.loggedIn) {
                    authPanel.style.display = "block";
                    chatPanel.classList.remove("show");
                    statusChip.textContent = "Not logged in";
                    adminControlsLink.style.display = "none";
                    trainerPanelLink.style.display = "none";
                    stopSessionPing();
                    return;
                }

                authPanel.style.display = "none";
                chatPanel.classList.add("show");
                statusChip.textContent = `Logged in as ${state.username}`;
                chatMeta.textContent = `${state.username}${state.isAdmin ? " (admin)" : ""}`;
                tokenBox.textContent = state.token
                    ? `Token: ${state.token}`
                    : "Token missing from session response.";
                adminControlsLink.style.display = isRootAdminSession()
                    ? "inline-flex"
                    : "none";
                trainerPanelLink.style.display = canAccessTrainerPanel()
                    ? "inline-flex"
                    : "none";
                promptInput.focus();
                startSessionPing();
            }

            /* Session ping via auth.js startSessionPing / stopSessionPing */

            async function requestJson(url, options = {}) {
                const headers = new Headers(options.headers || {});
                if (options.body && !headers.has("Content-Type")) {
                    headers.set("Content-Type", "application/json");
                }
                if (state.token && !headers.has("Authorization")) {
                    headers.set("Authorization", `Bearer ${state.token}`);
                }

                const response = await safeFetch(url, {
                    ...options,
                    headers,
                    credentials: "same-origin",
                });

                let payload = {};
                try {
                    payload = await response.json();
                } catch {
                    payload = {};
                }

                if (!response.ok) {
                    throw new Error(
                        payload.error || `Request failed (${response.status})`,
                    );
                }

                return payload;
            }

            async function bootstrapAuth() {
                try {
                    const data = await requestJson("/api/auth/status");
                    state.loggedIn = Boolean(data.logged_in);
                    state.username = data.username || "";
                    state.isAdmin = Boolean(data.is_admin);
                    state.isTrainer = Boolean(data.is_trainer);
                    if (data.token) {
                        state.token = data.token;
                        jeebsSetToken(state.token);
                    }
                    renderAuthState();
                    if (state.loggedIn) {
                        appendMessage(
                            "jeebs",
                            "You are authenticated. Ask me anything.",
                        );
                    }
                } catch (error) {
                    state.loggedIn = false;
                    renderAuthState();
                    setStatus(error.message, "bad");
                }
            }

            document.querySelectorAll(".tabs button").forEach((button) => {
                button.addEventListener("click", () =>
                    setView(button.dataset.view),
                );
            });

            document
                .getElementById("loginUsername")
                .addEventListener("input", updateUnsignedMessage);
            document
                .getElementById("generateChallengeBtn")
                .addEventListener("click", () => {
                    updateUnsignedMessage();
                    setStatus("Challenge refreshed.", "good");
                });
            document
                .getElementById("copyChallengeBtn")
                .addEventListener("click", async () => {
                    try {
                        await navigator.clipboard.writeText(
                            document.getElementById("unsignedMessage").value,
                        );
                        setStatus("Challenge copied.", "good");
                    } catch {
                        setStatus(
                            "Clipboard access failed. Copy manually.",
                            "bad",
                        );
                    }
                });

            document
                .getElementById("registerForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const username = document
                        .getElementById("regUsername")
                        .value.trim();
                    const email = document
                        .getElementById("regEmail")
                        .value.trim();
                    const pgpPublicKey = document
                        .getElementById("publicKey")
                        .value.trim();

                    try {
                        await requestJson("/api/register", {
                            method: "POST",
                            body: JSON.stringify({
                                username,
                                email,
                                pgp_public_key: pgpPublicKey,
                            }),
                        });

                        document.getElementById("loginUsername").value =
                            username;
                        updateUnsignedMessage();
                        setView("login");
                        setStatus(
                            "Registration complete. Sign the challenge and log in.",
                            "good",
                        );
                    } catch (error) {
                        setStatus(
                            `Registration failed: ${error.message}`,
                            "bad",
                        );
                    }
                });

            document
                .getElementById("loginForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();

                    const username = document
                        .getElementById("loginUsername")
                        .value.trim();
                    const signedMessage = document
                        .getElementById("signedMessage")
                        .value.trim();
                    const rememberMe =
                        document.getElementById("rememberMe").checked;

                    try {
                        const data = await requestJson("/api/login_pgp", {
                            method: "POST",
                            body: JSON.stringify({
                                username,
                                signed_message: signedMessage,
                                remember_me: rememberMe,
                            }),
                        });

                        state.loggedIn = true;
                        state.username = data.username || username;
                        state.isAdmin = Boolean(data.is_admin);
                        state.isTrainer = Boolean(data.is_trainer);
                        state.token = data.token || "";

                        if (state.token) {
                            jeebsSetToken(state.token);
                        }

                        renderAuthState();
                        appendMessage(
                            "jeebs",
                            "PGP login successful. Session token is active.",
                        );
                        setStatus("Logged in successfully.", "good");
                    } catch (error) {
                        setStatus(`Login failed: ${error.message}`, "bad");
                    }
                });

            document
                .getElementById("chatForm")
                .addEventListener("submit", async (event) => {
                    event.preventDefault();
                    if (!state.loggedIn) {
                        setStatus("Log in before sending messages.", "bad");
                        return;
                    }

                    const prompt = promptInput.value.trim();
                    if (!prompt) return;

                    appendMessage("user", prompt);
                    promptInput.value = "";

                    try {
                        const data = await requestJson("/api/chat", {
                            method: "POST",
                            body: JSON.stringify({ message: prompt }),
                        });
                        appendMessage(
                            "jeebs",
                            data.response || "(No response body)",
                        );
                    } catch (error) {
                        appendMessage("jeebs", `Error: ${error.message}`);
                        setStatus(
                            `Chat request failed: ${error.message}`,
                            "bad",
                        );
                    }
                });

            document
                .getElementById("copyTokenBtn")
                .addEventListener("click", async () => {
                    if (!state.token) {
                        setStatus("No token available.", "bad");
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(state.token);
                        setStatus("Token copied.", "good");
                    } catch {
                        setStatus(
                            "Clipboard access failed. Copy manually.",
                            "bad",
                        );
                    }
                });

            document
                .getElementById("logoutBtn")
                .addEventListener("click", async () => {
                    try {
                        await requestJson("/api/logout", { method: "POST" });
                    } catch {
                        // No-op; continue local cleanup.
                    }

                    state.loggedIn = false;
                    state.username = "";
                    state.isAdmin = false;
                    state.isTrainer = false;
                    state.token = "";
                    jeebsClearToken();
                    chatFeed.innerHTML = "";
                    setView("login");
                    renderAuthState();
                    setStatus("Logged out.", "good");
                });

            updateUnsignedMessage();
            renderAuthState();
            bootstrapAuth();
        </script>
    </body>
</html>
