<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Profile â€” JeebsAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/webui/style.css"/>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="padding-top:60px;max-width:800px">
  <div class="card card-glow" style="margin-bottom:24px;text-align:center">
    <h1 style="margin-bottom:8px">User Profile</h1>
    <p class="text-muted">Manage your JeebsAI account and settings.</p>
  </div>
  <div class="card card-glow">
    <h3>Account Details</h3>
    <div id="profileInfo" class="data-list"><div class="text-muted">Loading...</div></div>
    <form id="changeUsernameForm" style="margin-top:16px">
      <label class="form-label">Change Username</label>
      <div style="display:flex;gap:8px">
        <input type="text" id="newUsername" class="form-input" placeholder="New username" required style="flex:1"/>
        <button type="submit" class="btn btn-primary">Update</button>
      </div>
      <div id="usernameStatus" class="text-muted" style="margin-top:6px"></div>
    </form>
  </div>
  <div class="card">
    <h3>Profile Picture</h3>
    <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
      <img id="avatarImg" src="" alt="Avatar" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);background:var(--bg-1)"/>
      <form id="avatarForm" style="display:flex;flex-direction:column;gap:10px;flex:1;min-width:200px">
        <input type="file" id="avatarInput" accept="image/*" required class="form-input"/>
        <button type="submit" class="btn btn-primary btn-sm">Upload Picture</button>
      </form>
    </div>
  </div>
  <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">
    <div class="card">
      <h3>Update Email</h3>
      <form id="changeEmailForm" class="stack">
        <div><label class="form-label">New Email</label><input type="email" id="newEmail" class="form-input" required/></div>
        <div><label class="form-label">Current Password</label><input type="password" id="emailPass" class="form-input" required/></div>
        <button type="submit" class="btn btn-primary">Update Email</button>
        <div id="emailStatus" class="text-muted"></div>
      </form>
    </div>
    <div class="card">
      <h3>Change Password</h3>
      <form id="changePassForm" class="stack">
        <div><label class="form-label">Current Password</label><input type="password" id="oldPass" class="form-input" required/></div>
        <div><label class="form-label">New Password</label><input type="password" id="newPass" class="form-input" required/></div>
        <button type="submit" class="btn btn-primary">Update Password</button>
        <div id="passStatus" class="text-muted"></div>
      </form>
    </div>
  </div>

  <div class="card" style="border-color:var(--danger)">
    <h3 style="color:var(--danger)">Danger Zone</h3>
    <p class="text-muted" style="margin-bottom:12px">This action is permanent and cannot be undone.</p>
    <form id="deleteAccountForm" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
      <div style="flex:1;min-width:200px"><label class="form-label">Confirm Password</label><input type="password" id="deletePass" class="form-input" required/></div>
      <button type="submit" class="btn btn-danger">Delete My Account</button>
    </form>
    <div id="deleteStatus" class="text-muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h3>Recent Activity</h3>
    <div id="activityLog" class="scroll-box" style="max-height:300px"><div class="text-muted">Loading activity...</div></div>
  </div>
</div>

<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
JeebsNav.init('profile');

function escapeHtml(text){
  if(!text)return"";
  return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

async function loadProfile(){
  try{
    const res=await safeFetch("/api/profile",{credentials:"same-origin",headers:authHeaders()});
    if(res.ok){
      const data=await res.json();
      window.currentProfile=data;
      document.getElementById("profileInfo").innerHTML=
        '<div class="data-list-item"><span>Username</span><span>'+escapeHtml(data.username)+'</span></div>'+
        '<div class="data-list-item"><span>Email</span><span>'+escapeHtml(data.email)+'</span></div>'+
        '<div class="data-list-item"><span>Role</span><span class="badge badge-accent">'+escapeHtml(data.role)+'</span></div>';
      document.getElementById("avatarImg").src="/api/avatar/"+data.username+"?t="+Date.now();
    }else{
      document.getElementById("profileInfo").innerHTML='<div class="text-muted">Please log in to view profile.</div>';
    }
  }catch(e){
    document.getElementById("profileInfo").innerHTML='<div class="text-muted">Error loading profile.</div>';
  }
}

async function loadActivity(){
  try{
    if(window.currentProfile&&(window.currentProfile.role==='admin'||window.currentProfile.username==='1090mb')){
      document.getElementById("activityLog").innerHTML='<div class="text-muted">Recent activity hidden for privacy.</div>';
      return;
    }
    const res=await safeFetch("/api/my_logs",{credentials:"same-origin",headers:authHeaders()});
    if(res.ok){
      const logs=await res.json();
      if(logs.length===0){document.getElementById("activityLog").innerHTML='<div class="text-muted">No recent activity found.</div>';return;}
      document.getElementById("activityLog").innerHTML=logs.map(function(l){
        return '<div class="data-list-item" style="flex-direction:column;align-items:flex-start"><span class="text-muted" style="font-size:0.8em">['+new Date(l.timestamp).toLocaleString()+']</span><span style="font-family:var(--font-mono);font-size:0.9em">'+escapeHtml(l.message)+'</span></div>';
      }).join("");
    }else{
      document.getElementById("activityLog").innerHTML='<div class="text-muted">Could not load activity.</div>';
    }
  }catch(e){
    document.getElementById("activityLog").innerHTML='<div class="text-muted">Error loading activity.</div>';
  }
}

document.getElementById("changePassForm").onsubmit=async function(e){
  e.preventDefault();
  var status=document.getElementById("passStatus");
  status.textContent="Updating...";status.style.color="var(--text-1)";
  var res=await safeFetch("/api/change_password",{method:"POST",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({old_password:document.getElementById("oldPass").value,new_password:document.getElementById("newPass").value})});
  var data=await res.json();
  status.textContent=res.ok?"Password updated!":"Error: "+(data.error||"Unknown");
  status.style.color=res.ok?"var(--accent)":"var(--danger)";
  if(res.ok)document.getElementById("changePassForm").reset();
};

document.getElementById("changeUsernameForm").onsubmit=async function(e){
  e.preventDefault();
  var newUsername=document.getElementById("newUsername").value.trim();
  var status=document.getElementById("usernameStatus");
  if(!newUsername)return;
  status.textContent="Updating...";status.style.color="var(--text-1)";
  var res=await safeFetch("/api/profile/username",{method:"POST",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({new_username:newUsername})});
  var data=await res.json().catch(function(){return{}});
  if(res.ok){status.textContent="Username updated.";status.style.color="var(--accent)";document.getElementById("changeUsernameForm").reset();loadProfile();loadActivity();}
  else{status.textContent="Error: "+(data.error||"Unknown");status.style.color="var(--danger)";}
};

document.getElementById("changeEmailForm").onsubmit=async function(e){
  e.preventDefault();
  var status=document.getElementById("emailStatus");
  status.textContent="Updating...";status.style.color="var(--text-1)";
  var res=await safeFetch("/api/update_email",{method:"POST",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({new_email:document.getElementById("newEmail").value,password:document.getElementById("emailPass").value})});
  var data=await res.json();
  status.textContent=res.ok?"Email updated!":"Error: "+(data.error||"Unknown");
  status.style.color=res.ok?"var(--accent)":"var(--danger)";
  if(res.ok){document.getElementById("changeEmailForm").reset();loadProfile();}
};

document.getElementById("avatarForm").onsubmit=async function(e){
  e.preventDefault();
  var fileInput=document.getElementById("avatarInput");
  if(fileInput.files.length===0)return;
  var formData=new FormData();formData.append("avatar",fileInput.files[0]);
  var btn=e.target.querySelector("button");var orig=btn.textContent;btn.textContent="Uploading...";
  var res=await safeFetch("/api/upload_avatar",{method:"POST",credentials:"same-origin",headers:{Authorization:"Bearer "+jeebsGetToken()},body:formData});
  if(res.ok)loadProfile();
  btn.textContent=orig;fileInput.value="";
};

document.getElementById("deleteAccountForm").onsubmit=async function(e){
  e.preventDefault();
  if(!confirm("Are you absolutely sure you want to delete your account? This cannot be undone."))return;
  var status=document.getElementById("deleteStatus");
  status.textContent="Deleting...";
  var res=await safeFetch("/api/delete_account",{method:"POST",credentials:"same-origin",headers:authHeaders(true),body:JSON.stringify({password:document.getElementById("deletePass").value})});
  var data=await res.json();
  if(res.ok){alert("Account deleted. Goodbye!");window.location.href="/webui/index.html";}
  else{status.textContent="Error: "+(data.error||"Unknown");status.style.color="var(--danger)";}
};

loadProfile().then(loadActivity);
</script>
</body>
</html>
