<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>User Profile - JeebsAI</title>
        <style>
            :root {
                --bg-main: #181c24;
                --bg-card: #23283a;
                --text-main: #f3f3f3;
                --accent: #7fffd4;
                --border: #333;
            }
            body.light-mode {
                --bg-main: #f4f4f9;
                --bg-card: #ffffff;
                --text-main: #333;
                --accent: #00796b;
                --border: #ccc;
            }
            body {
                font-family: "Segoe UI", sans-serif;
                background: var(--bg-main);
                color: var(--text-main);
                padding: 20px;
                margin: 0;
                transition:
                    background 0.3s,
                    color 0.3s;
            }
            .container {
                max-width: 800px;
                margin: 0 auto;
            }
            .card {
                background: var(--bg-card);
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                border: 1px solid var(--border);
            }
            h1,
            h2 {
                color: var(--accent);
                margin-top: 0;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input {
                width: 100%;
                padding: 10px;
                margin-bottom: 15px;
                border-radius: 4px;
                border: 1px solid var(--border);
                background: var(--bg-main);
                color: var(--text-main);
                box-sizing: border-box;
            }
            button {
                padding: 10px 20px;
                background: var(--accent);
                color: var(--bg-main);
                border: none;
                border-radius: 4px;
                font-weight: bold;
                cursor: pointer;
            }
            button:hover {
                opacity: 0.9;
            }
            .log-entry {
                padding: 8px;
                border-bottom: 1px solid var(--border);
                font-family: monospace;
                font-size: 0.9em;
            }
            .log-entry:last-child {
                border-bottom: none;
            }
            .timestamp {
                color: #888;
                margin-right: 10px;
            }
            a {
                color: var(--accent);
                text-decoration: none;
            }
            .status {
                margin-top: 10px;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div
                style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                "
            >
                <h1>User Profile</h1>
                <a href="/webui/index.html">Back to Home</a>
            </div>

            <div class="card">
                <h2>Account Details</h2>
                <div id="profileInfo">Loading...</div>
            </div>

            <div class="card">
                <h2>Profile Picture</h2>
                <div style="display: flex; align-items: center; gap: 20px">
                    <img
                        id="avatarImg"
                        src=""
                        style="
                            width: 100px;
                            height: 100px;
                            border-radius: 50%;
                            object-fit: cover;
                            border: 2px solid var(--accent);
                            background: var(--bg-main);
                        "
                    />
                    <form
                        id="avatarForm"
                        style="display: flex; flex-direction: column; gap: 10px"
                    >
                        <input
                            type="file"
                            id="avatarInput"
                            accept="image/*"
                            required
                            style="margin: 0"
                        />
                        <button type="submit">Upload New Picture</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <h2>Update Email</h2>
                <form id="changeEmailForm">
                    <label>New Email Address</label>
                    <input type="email" id="newEmail" required />
                    <label>Current Password</label>
                    <input type="password" id="emailPass" required />
                    <button type="submit">Update Email</button>
                    <div id="emailStatus" class="status"></div>
                </form>
            </div>

            <div class="card">
                <h2>Change Password</h2>
                <form id="changePassForm">
                    <label>Current Password</label>
                    <input type="password" id="oldPass" required />
                    <label>New Password</label>
                    <input type="password" id="newPass" required />
                    <button type="submit">Update Password</button>
                    <div id="passStatus" class="status"></div>
                </form>
            </div>

            <div class="card">
                <h2 style="color: #ff6b6b">Delete Account</h2>
                <p>Warning: This action is permanent and cannot be undone.</p>
                <form id="deleteAccountForm">
                    <label>Confirm Password</label>
                    <input type="password" id="deletePass" required />
                    <button type="submit" style="background: #ff6b6b">
                        Delete My Account
                    </button>
                    <div id="deleteStatus" class="status"></div>
                </form>
            </div>

            <div class="card">
                <h2>Recent Activity</h2>
                <div id="activityLog">Loading activity...</div>
            </div>
        </div>

        <script src="/webui/auth.js"></script><script>
            // Theme Init
            if (localStorage.getItem("theme") === "light")
                document.body.classList.add("light-mode");

            async function loadProfile() {
                try {
                    const res = await safeFetch("/api/profile", { credentials: "same-origin", headers: authHeaders() });
                    if (res.ok) {
                        const data = await res.json();
                        document.getElementById("profileInfo").innerHTML = `
                        <p><strong>Username:</strong> ${data.username}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Role:</strong> ${data.role}</p>
                    `;
                        document.getElementById("avatarImg").src =
                            `/api/avatar/${data.username}?t=${new Date().getTime()}`;
                    } else {
                        document.getElementById("profileInfo").innerHTML =
                            "<p>Please log in to view profile.</p>";
                    }
                } catch (e) {
                    document.getElementById("profileInfo").innerHTML =
                        "<p>Error loading profile.</p>";
                }
            }

            async function loadActivity() {
                try {
                    const res = await safeFetch("/api/my_logs", { credentials: "same-origin", headers: authHeaders() });
                    if (res.ok) {
                        const logs = await res.json();
                        if (logs.length === 0) {
                            document.getElementById("activityLog").innerHTML =
                                "<p>No recent activity found.</p>";
                            return;
                        }
                        document.getElementById("activityLog").innerHTML = logs
                            .map(
                                (l) => `
                        <div class="log-entry">
                            <span class="timestamp">[${new Date(l.timestamp).toLocaleString()}]</span>
                            ${escapeHtml(l.message)}
                        </div>
                    `,
                            )
                            .join("");
                    } else {
                        document.getElementById("activityLog").innerHTML =
                            "<p>Could not load activity.</p>";
                    }
                } catch (e) {
                    document.getElementById("activityLog").innerHTML =
                        "<p>Error loading activity.</p>";
                }
            }

            document.getElementById("changePassForm").onsubmit = async (e) => {
                e.preventDefault();
                const oldPass = document.getElementById("oldPass").value;
                const newPass = document.getElementById("newPass").value;
                const status = document.getElementById("passStatus");

                status.textContent = "Updating...";
                status.style.color = "var(--text-main)";

                const res = await safeFetch("/api/change_password", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: authHeaders(true),
                    body: JSON.stringify({
                        old_password: oldPass,
                        new_password: newPass,
                    }),
                });

                const data = await res.json();
                status.textContent = res.ok
                    ? "Password updated successfully!"
                    : "Error: " + (data.error || "Unknown");
                status.style.color = res.ok ? "var(--accent)" : "#ff6b6b";
                if (res.ok) document.getElementById("changePassForm").reset();
            };

            document.getElementById("changeEmailForm").onsubmit = async (e) => {
                e.preventDefault();
                const newEmail = document.getElementById("newEmail").value;
                const pass = document.getElementById("emailPass").value;
                const status = document.getElementById("emailStatus");

                status.textContent = "Updating...";
                status.style.color = "var(--text-main)";

                const res = await safeFetch("/api/update_email", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: authHeaders(true),
                    body: JSON.stringify({
                        new_email: newEmail,
                        password: pass,
                    }),
                });

                const data = await res.json();
                status.textContent = res.ok
                    ? "Email updated successfully!"
                    : "Error: " + (data.error || "Unknown");
                status.style.color = res.ok ? "var(--accent)" : "#ff6b6b";
                if (res.ok) {
                    document.getElementById("changeEmailForm").reset();
                    loadProfile();
                }
            };

            document.getElementById("avatarForm").onsubmit = async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById("avatarInput");
                if (fileInput.files.length === 0) return;

                const formData = new FormData();
                formData.append("avatar", fileInput.files[0]);

                const btn = e.target.querySelector("button");
                const originalText = btn.textContent;
                btn.textContent = "Uploading...";

                const res = await safeFetch("/api/upload_avatar", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: { Authorization: "Bearer " + jeebsGetToken() },
                    body: formData,
                });
                if (res.ok) loadProfile(); // Reloads avatar image
                btn.textContent = originalText;
                fileInput.value = "";
            };

            document.getElementById("deleteAccountForm").onsubmit = async (
                e,
            ) => {
                e.preventDefault();
                if (
                    !confirm(
                        "Are you absolutely sure you want to delete your account? This cannot be undone.",
                    )
                )
                    return;

                const pass = document.getElementById("deletePass").value;
                const status = document.getElementById("deleteStatus");

                status.textContent = "Deleting...";

                const res = await safeFetch("/api/delete_account", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: authHeaders(true),
                    body: JSON.stringify({ password: pass }),
                });

                const data = await res.json();
                if (res.ok) {
                    alert("Account deleted. Goodbye!");
                    window.location.href = "/webui/index.html";
                } else {
                    status.textContent = "Error: " + (data.error || "Unknown");
                    status.style.color = "#ff6b6b";
                }
            };

            function escapeHtml(text) {
                if (!text) return "";
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            loadProfile();
            loadActivity();
        </script>
    </body>
</html>
