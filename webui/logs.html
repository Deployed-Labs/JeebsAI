<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>System Logs â€” JeebsAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/webui/style.css"/>
<style>
#log-container{background:var(--bg-0);border:1px solid var(--border);border-radius:10px;padding:12px;height:68vh;overflow-y:auto;font-family:var(--font-mono);font-size:0.85rem;line-height:1.5;white-space:pre-wrap}
.log-entry{padding:3px 4px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:background .1s}
.log-entry:hover{background:rgba(255,255,255,0.04)}
.log-entry:last-child{border-bottom:none}
.log-entry.error{color:var(--danger)}
.log-entry.warn{color:var(--accent-2)}
.log-entry.info{color:var(--accent)}
.highlight{background:var(--accent-2);color:var(--bg-0);font-weight:700;border-radius:2px;padding:0 2px}
.paused{background:#ff9800!important;color:var(--bg-0)!important}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;justify-content:center;align-items:center}
.modal-content{background:var(--panel);padding:24px;border-radius:12px;width:90%;max-width:800px;border:1px solid var(--accent);position:relative;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.modal-close{position:absolute;top:12px;right:12px;background:transparent;border:none;color:var(--danger);font-size:1.5em;cursor:pointer}
.modal-row{margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px}
.modal-label{color:var(--accent);font-weight:700;display:inline-block;width:100px}
</style>
</head>
<body>
<nav id="topnav"></nav>
<div class="shell" style="padding-top:60px;max-width:1200px">
  <h1 style="margin-bottom:16px">System Logs</h1>

  <div class="card" style="padding:12px;margin-bottom:8px">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <select id="categoryFilter" class="form-input" onchange="currentPage=1;fetchLogs()" style="width:auto">
        <option value="All">All Categories</option>
      </select>
      <select id="levelFilter" class="form-input" onchange="currentPage=1;fetchLogs()" style="width:auto">
        <option value="All">All Levels</option>
        <option value="INFO">INFO</option>
        <option value="WARN">WARN</option>
        <option value="ERROR">ERROR</option>
      </select>
      <input type="text" id="searchInput" class="form-input" placeholder="Search logs..." style="width:160px" onkeydown="if(event.key==='Enter'){currentPage=1;fetchLogs();}"/>
      <input type="text" id="highlightInput" class="form-input" placeholder="Highlight..." style="width:120px" oninput="renderCurrentLogs()"/>
      <input type="datetime-local" id="startDate" class="form-input" style="width:auto"/>
      <input type="datetime-local" id="endDate" class="form-input" style="width:auto"/>
      <button class="btn btn-primary btn-sm" onclick="fetchLogs()">Refresh</button>
      <button class="btn btn-danger btn-sm" onclick="clearLogs()">Clear All</button>
      <button class="btn btn-ghost btn-sm" onclick="exportLogs()">Export CSV</button>
      <label class="text-muted" style="display:flex;align-items:center;gap:4px;font-size:0.85em"><input type="checkbox" id="liveStream"/> Live</label>
      <button id="pauseBtn" class="btn btn-ghost btn-sm" onclick="togglePause()" style="display:none">Pause</button>
    </div>
  </div>

  <div style="display:flex;justify-content:flex-end;gap:8px;align-items:center;margin-bottom:8px">
    <button class="btn btn-ghost btn-sm" onclick="changePage(-1)">&laquo; Prev</button>
    <span id="pageIndicator" class="text-muted">Page 1</span>
    <button class="btn btn-ghost btn-sm" onclick="changePage(1)">Next &raquo;</button>
  </div>

  <div id="log-container">Loading logs...</div>
</div>

<!-- Log Detail Modal -->
<div id="logModal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <button class="btn btn-ghost btn-sm" onclick="copyLogDetails()" style="position:absolute;top:12px;right:50px">Copy</button>
    <h2 style="color:var(--accent);margin:0 0 16px">Log Details</h2>
    <div class="modal-row"><span class="modal-label">ID:</span><span id="m-id"></span></div>
    <div class="modal-row"><span class="modal-label">Timestamp:</span><span id="m-time"></span></div>
    <div class="modal-row"><span class="modal-label">Level:</span><span id="m-level"></span></div>
    <div class="modal-row"><span class="modal-label">Category:</span><span id="m-cat"></span></div>
    <div class="modal-row" style="border-bottom:none"><span class="modal-label">Message:</span></div>
    <pre id="m-msg" style="background:var(--bg-0);padding:12px;border-radius:8px;white-space:pre-wrap;max-height:400px;overflow-y:auto;font-family:var(--font-mono);font-size:0.85em;border:1px solid var(--border)"></pre>
  </div>
</div>

<script src="/webui/auth.js"></script>
<script src="/webui/nav.js"></script>
<script>
JeebsNav.init('logs');

var container=document.getElementById("log-container");
var currentPage=1;var limit=50;var currentLogs=[];var ws=null;var isPaused=false;

function escapeHtml(t){if(!t)return"";return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");}

async function fetchCategories(){
  try{var res=await safeFetch("/api/admin/log_categories",{credentials:"same-origin",headers:authHeaders()});
  if(!res.ok)return;var cats=await res.json();var sel=document.getElementById("categoryFilter");var cur=sel.value;
  sel.innerHTML=cats.map(function(c){return'<option value="'+c+'">'+c+'</option>';}).join("");
  if(cats.includes(cur))sel.value=cur;}catch(e){}
}

async function fetchLogs(){
  try{
    var cat=document.getElementById("categoryFilter").value;var level=document.getElementById("levelFilter").value;
    var search=document.getElementById("searchInput").value;var start=document.getElementById("startDate").value;var end=document.getElementById("endDate").value;
    var params=new URLSearchParams({page:String(currentPage),limit:String(limit)});
    if(cat&&cat!=="All")params.set("category",cat);if(level&&level!=="All")params.set("level",level);
    if(search)params.set("search",search);if(start)params.set("start_date",start);if(end)params.set("end_date",end);
    var res=await safeFetch("/api/admin/logs?"+params.toString(),{credentials:"same-origin",headers:authHeaders()});
    if(res.status===401||res.status===403){container.innerHTML='<span style="color:var(--danger)">Access Denied. Admin privileges required.</span>';return;}
    if(!res.ok){container.innerHTML='<span style="color:var(--danger)">Failed to fetch logs.</span>';return;}
    var logs=await res.json();currentLogs=logs;
    document.getElementById("pageIndicator").innerText="Page "+currentPage;
    renderCurrentLogs();
  }catch(e){container.innerHTML='<span style="color:var(--danger)">Connection error.</span>';}
}

function renderCurrentLogs(){
  if(!currentLogs||!currentLogs.length){container.innerHTML="<i class='text-muted'>No logs available.</i>";return;}
  var wasAtBottom=container.scrollHeight-container.scrollTop<=container.clientHeight+50;
  var logsToRender=currentLogs.slice().reverse();
  container.innerHTML=logsToRender.map(function(line){
    var cls=line.level==="ERROR"?"error":line.level==="WARN"?"warn":"info";
    return '<div class="log-entry '+cls+'" onclick="showLogDetails('+line.id+')"><span style="color:var(--text-2)">['+line.timestamp+']</span> <strong style="color:var(--accent)">['+line.category+']</strong> '+formatLogMessage(line.message)+'</div>';
  }).join("");
  if(wasAtBottom)container.scrollTop=container.scrollHeight;
}

function formatLogMessage(text){
  var term=document.getElementById("highlightInput").value;if(!term)return escapeHtml(text);
  var regex=new RegExp("("+escapeRegExp(term)+")","gi");
  return text.split(regex).map(function(part){
    if(part.toLowerCase()===term.toLowerCase())return'<span class="highlight">'+escapeHtml(part)+'</span>';
    return escapeHtml(part);
  }).join("");
}

function exportLogs(){
  var cat=document.getElementById("categoryFilter").value;var level=document.getElementById("levelFilter").value;
  var search=document.getElementById("searchInput").value;var start=document.getElementById("startDate").value;var end=document.getElementById("endDate").value;
  var params=new URLSearchParams();
  if(cat&&cat!=="All")params.set("category",cat);if(level&&level!=="All")params.set("level",level);
  if(search)params.set("search",search);if(start)params.set("start_date",start);if(end)params.set("end_date",end);
  var q=params.toString();window.location.href=q?"/api/admin/logs/export?"+q:"/api/admin/logs/export";
}

function changePage(delta){var n=currentPage+delta;if(n<1)return;currentPage=n;fetchLogs();}

async function clearLogs(){
  if(!confirm("Delete ALL logs? This cannot be undone."))return;
  await safeFetch("/api/admin/logs",{method:"DELETE",credentials:"same-origin",headers:authHeaders()});
  currentPage=1;fetchLogs();
}

function togglePause(){
  isPaused=!isPaused;var btn=document.getElementById("pauseBtn");
  if(isPaused){btn.textContent="Resume";btn.classList.add("paused");}
  else{btn.textContent="Pause";btn.classList.remove("paused");renderCurrentLogs();}
}

function showLogDetails(id){
  var log=currentLogs.find(function(l){return l.id==id;});if(!log)return;
  document.getElementById("m-id").textContent=log.id;
  document.getElementById("m-time").textContent=log.timestamp;
  document.getElementById("m-level").textContent=log.level;
  document.getElementById("m-cat").textContent=log.category;
  document.getElementById("m-msg").textContent=log.message;
  var levelEl=document.getElementById("m-level");
  if(log.level==="ERROR")levelEl.style.color="var(--danger)";
  else if(log.level==="WARN")levelEl.style.color="var(--accent-2)";
  else levelEl.style.color="var(--accent)";
  document.getElementById("logModal").style.display="flex";
}

function closeModal(){document.getElementById("logModal").style.display="none";}

function copyLogDetails(){
  var text="ID: "+document.getElementById("m-id").textContent+"\nTimestamp: "+document.getElementById("m-time").textContent+"\nLevel: "+document.getElementById("m-level").textContent+"\nCategory: "+document.getElementById("m-cat").textContent+"\nMessage: "+document.getElementById("m-msg").textContent;
  navigator.clipboard.writeText(text);
}

document.addEventListener("keydown",function(e){if(e.key==="Escape")closeModal();});

document.getElementById("liveStream").onchange=function(e){
  if(e.target.checked){startWebSocket();document.getElementById("pauseBtn").style.display="inline-block";}
  else{if(ws)ws.close();document.getElementById("pauseBtn").style.display="none";}
};

function startWebSocket(){
  var proto=window.location.protocol==="https:"?"wss":"ws";
  ws=new WebSocket(proto+"://"+window.location.host+"/api/admin/logs/stream");
  ws.onmessage=function(event){var log=JSON.parse(event.data);currentLogs.unshift(log);if(currentLogs.length>1000)currentLogs.pop();if(!isPaused)renderCurrentLogs();};
  ws.onclose=function(){if(document.getElementById("liveStream").checked)setTimeout(startWebSocket,2000);};
}

(async function(){var auth=await requireAuth("admin");if(!auth)return;startAuthGuard("admin");fetchCategories();fetchLogs();})();
</script>
</body>
</html>
