name: Multi-Platform Testing

on:
  push:
    branches: [ dev, main, develop ]
  pull_request:
    branches: [ dev, main, develop ]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

jobs:
  # Linux Testing
  test-linux:
    name: Test on Linux (Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config libssl-dev sqlite3 nettle-dev clang llvm
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-target-
    
    - name: Check formatting
      run: cargo fmt -- --check
    
    - name: Run clippy
      run: cargo clippy -- -D warnings
    
    - name: Build project
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
    
    - name: Build release
      run: cargo build --release --verbose

  # macOS Testing
  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        brew install pkg-config openssl sqlite nettle
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-target-
    
    - name: Build project
      run: cargo build --verbose
      env:
        PKG_CONFIG_PATH: /usr/local/opt/openssl/lib/pkgconfig
    
    - name: Run tests
      run: cargo test --verbose
      env:
        PKG_CONFIG_PATH: /usr/local/opt/openssl/lib/pkgconfig
    
    - name: Build release
      run: cargo build --release --verbose
      env:
        PKG_CONFIG_PATH: /usr/local/opt/openssl/lib/pkgconfig

  # Windows Testing
  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install vcpkg dependencies
      run: |
        vcpkg install openssl:x64-windows-static-md
        vcpkg integrate install
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-target-
    
    - name: Build project
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
    
    - name: Build release
      run: cargo build --release --verbose

  # iOS Build Testing (cross-compilation)
  test-ios:
    name: Test iOS Build
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        brew install pkg-config openssl sqlite nettle
    
    - name: Install Rust toolchain with iOS targets
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-ios, x86_64-apple-ios

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ios-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ios-cargo-registry-
    
    - name: Build for iOS Simulator (x86_64)
      run: cargo build --target x86_64-apple-ios --verbose
      continue-on-error: true
      env:
        PKG_CONFIG_PATH: /usr/local/opt/openssl/lib/pkgconfig
    
    - name: Build for iOS Device (ARM64)
      run: cargo build --target aarch64-apple-ios --verbose
      continue-on-error: true
      env:
        PKG_CONFIG_PATH: /usr/local/opt/openssl/lib/pkgconfig

  # Android Build Testing (cross-compilation)
  test-android:
    name: Test Android Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config libssl-dev sqlite3 nettle-dev clang llvm
    
    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
    
    - name: Install Rust toolchain with Android targets
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android, armv7-linux-androideabi, i686-linux-android, x86_64-linux-android

    - name: Install cargo-ndk
      run: cargo install cargo-ndk

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: android-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          android-cargo-registry-
    
    - name: Build for Android ARM64
      run: cargo build --target aarch64-linux-android --verbose
      continue-on-error: true
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
    
    - name: Build for Android ARMv7
      run: cargo build --target armv7-linux-androideabi --verbose
      continue-on-error: true
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
