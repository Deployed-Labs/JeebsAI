name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy:
    name: Build & Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev libsqlite3-dev clang llvm

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-deploy-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-deploy-

      - name: Build release binary
        run: cargo build --release

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            set -e
            echo "ðŸš€ Starting deployment on VPS..."

            TARGET="${{ secrets.VPS_TARGET }}"
            if [ -z "$TARGET" ]; then TARGET="/root/JeebsAI"; fi
            mkdir -p "$TARGET"
            cd "$TARGET"

            # Ensure cargo/rust are available
            export PATH="$HOME/.cargo/bin:/usr/local/bin:$PATH"

            # Install build deps on VPS if missing
            if ! command -v pkg-config &>/dev/null; then
              echo "Installing build dependencies on VPS..."
              apt-get update -qq
              apt-get install -y -qq build-essential pkg-config libssl-dev libsqlite3-dev \
                clang llvm curl git
            fi

            # Install Rust if missing
            if ! command -v cargo &>/dev/null; then
              echo "Installing Rust on VPS..."
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              export PATH="$HOME/.cargo/bin:$PATH"
            fi

            # Clone or update repo
            if [ ! -d ".git" ]; then
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }} .
            else
              echo "Updating repository..."
              git fetch origin
              git reset --hard origin/main
            fi

            # Build release
            echo "Building release binary on VPS..."
            cargo build --release

            # Ensure DB exists
            [ -f "$TARGET/jeebs.db" ] || touch "$TARGET/jeebs.db"

            # Create/update systemd service
            cat > /etc/systemd/system/jeebs.service <<UNIT
          [Unit]
          Description=JeebsAI Server
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=$TARGET
          Environment=PORT=8080
          Environment=DATABASE_URL=sqlite:$TARGET/jeebs.db
          Environment=RUST_LOG=info
          ExecStart=$TARGET/target/release/jeebs
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
          UNIT

            systemctl daemon-reload
            systemctl enable jeebs
            systemctl restart jeebs
            sleep 3

            if systemctl is-active --quiet jeebs; then
              echo "âœ… JeebsAI is running!"
              curl -sf -o /dev/null -w "   Health: HTTP %{http_code}\n" http://127.0.0.1:8080/api/health || true
            else
              echo "âŒ Service failed to start"
              journalctl -u jeebs --no-pager -n 20
              exit 1
            fi

      - name: Report status
        if: failure()
        run: echo "âŒ Build or deploy failed. Check logs above."
